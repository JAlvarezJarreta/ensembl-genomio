<!DOCTYPE html>

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ensembl.brc4.runnable.load_sequence_data &#8212; ensembl-genomio 0.1 documentation</title>
    <link rel="stylesheet" type="text/css" href="../../../../_static/pygments.css?v=a746c00c" />
    <link rel="stylesheet" type="text/css" href="../../../../_static/agogo.css?v=cc331ede" />
    <script data-url_root="../../../../" id="documentation_options" src="../../../../_static/documentation_options.js?v=e031e9a9"></script>
    <script src="../../../../_static/doctools.js?v=888ff710"></script>
    <script src="../../../../_static/sphinx_highlight.js?v=4825356b"></script>
    <link rel="index" title="Index" href="../../../../genindex.html" />
    <link rel="search" title="Search" href="../../../../search.html" /> 
  </head><body>
    <div class="header-wrapper" role="banner">
      <div class="header">
        <div class="headertitle"><a
          href="../../../../index.html">ensembl-genomio 0.1 documentation</a></div>
        <div class="rel" role="navigation" aria-label="related navigation">
          <a href="../../../../py-modindex.html" title="Python Module Index"
             >modules</a> |
          <a href="../../../../genindex.html" title="General Index"
             accesskey="I">index</a>
        </div>
       </div>
    </div>

    <div class="content-wrapper">
      <div class="content">
        <div class="document">
            
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for ensembl.brc4.runnable.load_sequence_data</h1><div class="highlight"><pre>
<span></span><span class="ch">#!env python3</span>
<span class="c1"># See the NOTICE file distributed with this work for additional information</span>
<span class="c1"># regarding copyright ownership.</span>
<span class="c1">#</span>
<span class="c1"># Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);</span>
<span class="c1"># you may not use this file except in compliance with the License.</span>
<span class="c1"># You may obtain a copy of the License at</span>
<span class="c1">#</span>
<span class="c1">#      http://www.apache.org/licenses/LICENSE-2.0</span>
<span class="c1">#</span>
<span class="c1"># Unless required by applicable law or agreed to in writing, software</span>
<span class="c1"># distributed under the License is distributed on an &quot;AS IS&quot; BASIS,</span>
<span class="c1"># WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</span>
<span class="c1"># See the License for the specific language governing permissions and</span>
<span class="c1"># limitations under the License.</span>


<span class="kn">import</span> <span class="nn">eHive</span>
<span class="kn">import</span> <span class="nn">gzip</span>
<span class="kn">import</span> <span class="nn">io</span>
<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">subprocess</span> <span class="k">as</span> <span class="nn">sp</span>
<span class="kn">import</span> <span class="nn">sys</span>

<span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">defaultdict</span>
<span class="kn">from</span> <span class="nn">os.path</span> <span class="kn">import</span> <span class="n">dirname</span><span class="p">,</span> <span class="n">join</span> <span class="k">as</span> <span class="n">pj</span>


<div class="viewcode-block" id="load_sequence_data"><a class="viewcode-back" href="../../../../ensembl.brc4.runnable.html#ensembl.brc4.runnable.load_sequence_data.load_sequence_data">[docs]</a><span class="k">class</span> <span class="nc">load_sequence_data</span><span class="p">(</span><span class="n">eHive</span><span class="o">.</span><span class="n">BaseRunnable</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    loading sequence data, seq region names, atrributes and synonyms</span>

<span class="sd">    eHive module to load sequnce data, seq region names, atrributes and synonyms from FASTAs AGPs and seq_region.json.</span>
<span class="sd">    Various ensembl-analysis perl scripts are used to create coord_systems, load sequences and set attributes.</span>
<span class="sd">    SQL commands through out the code to be replaces with the proper python API at some point.</span>
<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="load_sequence_data.param_defaults"><a class="viewcode-back" href="../../../../ensembl.brc4.runnable.html#ensembl.brc4.runnable.load_sequence_data.load_sequence_data.param_defaults">[docs]</a>    <span class="k">def</span> <span class="nf">param_defaults</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        default parameter/options values</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="c1"># relative order of the coord_systems types to infer their rank from</span>
            <span class="s2">&quot;cs_order&quot;</span><span class="p">:</span> <span class="s2">&quot;ensembl_internal,chunk,contig,supercontig,non_ref_scaffold,scaffold,primary_assembly,superscaffold,linkage_group,chromosome&quot;</span><span class="p">,</span>
            <span class="s2">&quot;IUPAC&quot;</span><span class="p">:</span> <span class="s2">&quot;RYKMSWBDHV&quot;</span><span class="p">,</span>  <span class="c1"># symbols to be replaced with N in the DNA sequences (ensembl core(107) doesn&#39;t support the whole IUPAC alphabet for DNA)</span>
            <span class="c1"># unversion scaffold, remove &quot;.\d$&quot; from seq_region.names if there&#39;s a need</span>
            <span class="s2">&quot;unversion_scaffolds&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
            <span class="s2">&quot;versioned_sr_syn_src&quot;</span><span class="p">:</span> <span class="s2">&quot;INSDC&quot;</span><span class="p">,</span>  <span class="c1"># INSDC(50710) # if unversioning non-sequence level cs, store original name (with version) as this synonym</span>
            <span class="s2">&quot;sr_syn_src&quot;</span><span class="p">:</span> <span class="s2">&quot;BRC4_Community_Symbol&quot;</span><span class="p">,</span>  <span class="c1"># BRC4_Community_Symbol(211) # if unversioning sequence-level cs, store original name (with version) as this synonym</span>
            <span class="c1"># nullify coord_system version for the given coord_system name</span>
            <span class="s2">&quot;nullify_cs_version_from&quot;</span><span class="p">:</span> <span class="s2">&quot;contig&quot;</span><span class="p">,</span>
            <span class="c1"># default coord_system name for single-level (no AGPs assemblies)</span>
            <span class="s2">&quot;noagp_cs_name_default&quot;</span><span class="p">:</span> <span class="s2">&quot;primary_assembly&quot;</span><span class="p">,</span>
            <span class="c1"># file for additional mapping of the synonym sources to the external_db (ensembl), as used by &quot;get_external_db_mapping&quot; function below</span>
            <span class="s2">&quot;external_db_map&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
            <span class="c1"># set &quot;coord_system_tag&quot; seq_region attribute to this value if there&#39;s a corresponding &quot;chromosome_display_order&quot; list in genome.json metadata</span>
            <span class="c1">#   if None, only &quot;chromosome&quot; coord system is processed (if present)</span>
            <span class="c1">#   (see add_chr_karyotype_rank definition below )</span>
            <span class="c1">#   if seq_region already has `coord_system_tagi` attribute, it value updated only if &quot;force_update_coord_system_tag&quot; module param is True (see below)</span>
            <span class="s2">&quot;cs_tag_for_ordered&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
            <span class="c1"># Force updating of the &quot;coord_system_tags&quot; attribute for seq_regions from `cs_tag_for_ordered` (see above)</span>
            <span class="s2">&quot;force_update_coord_system_tag&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
            <span class="c1"># BRC4 compatibility mode; if on, &quot;(EBI|BRC4)_seq_region_name&quot; seq_region_attributes are added.</span>
            <span class="c1">#   Blocked by the &quot;swap_gcf_gca&quot; option. In this case insertion should be done on later pipeline stage after seq_region name swapping.</span>
            <span class="s2">&quot;brc4_mode&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
            <span class="c1"># Whether to use RefSeq names as additional seq_region synonyms (if available) or not (see add_sr_synonyms definition below)</span>
            <span class="c1">#  Does not swap anything actually, just loads synonyms to be used by a later &quot;swapping&quot; stage</span>
            <span class="c1">#  Disables BRC4 compatibilty mode (see the &quot;brc4_mode&quot; option comment).</span>
            <span class="s2">&quot;swap_gcf_gca&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
            <span class="c1"># list of coord systems used in &quot;-ignore_coord_system&quot; options of the &quot;ensembl-analysis/scripts/assembly_loading/set_toplevel.pl&quot; script</span>
            <span class="c1">#   part of the loading process</span>
            <span class="s2">&quot;not_toplevel_cs&quot;</span><span class="p">:</span> <span class="p">[],</span>  <span class="c1"># i.e. &quot;contig&quot;, &quot;non_ref_scaffold&quot;</span>
            <span class="c1"># explicit list of seq_region properties (keys) to load as seq_region_attrib s (values) (see add_sr_attribs definition below)</span>
            <span class="c1">#   if a dict&#39;s used as a value, treat its keys as &quot;json_path&quot; (/ as delim) map, i.e.</span>
            <span class="c1">#       { &quot;added_sequence&quot; : { &quot;assembly_provider&quot; : { &quot;name&quot; : ... } } } -&gt; &quot;added_sequence/assembly_provider/name&quot;</span>
            <span class="c1">#   only flattable properties can be used, no arrays</span>
            <span class="c1">#   arrays should be processed separately (see `add_sr_synonyms` or `add_karyotype_bands` definitions)</span>
            <span class="c1"># see schemas/seq_region_schema.json</span>
            <span class="s2">&quot;sr_attrib_types&quot;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s2">&quot;circular&quot;</span><span class="p">:</span> <span class="s2">&quot;circular_seq&quot;</span><span class="p">,</span>
                <span class="s2">&quot;codon_table&quot;</span><span class="p">:</span> <span class="s2">&quot;codon_table&quot;</span><span class="p">,</span>
                <span class="s2">&quot;location&quot;</span><span class="p">:</span> <span class="s2">&quot;sequence_location&quot;</span><span class="p">,</span>
                <span class="s2">&quot;non_ref&quot;</span><span class="p">:</span> <span class="s2">&quot;non_ref&quot;</span><span class="p">,</span>
                <span class="s2">&quot;coord_system_level&quot;</span><span class="p">:</span> <span class="s2">&quot;coord_system_tag&quot;</span><span class="p">,</span>
                <span class="s2">&quot;added_sequence&quot;</span><span class="p">:</span> <span class="p">{</span>
                    <span class="c1"># json_path to attrib_type_code(str) mapping</span>
                    <span class="s2">&quot;added_sequence/accession&quot;</span><span class="p">:</span> <span class="s2">&quot;added_seq_accession&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;added_sequence/assembly_provider/name&quot;</span><span class="p">:</span> <span class="s2">&quot;added_seq_asm_pr_nam&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;added_sequence/assembly_provider/url&quot;</span><span class="p">:</span> <span class="s2">&quot;added_seq_asm_pr_url&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;added_sequence/annotation_provider/name&quot;</span><span class="p">:</span> <span class="s2">&quot;added_seq_ann_pr_nam&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;added_sequence/annotation_provider/url&quot;</span><span class="p">:</span> <span class="s2">&quot;added_seq_ann_pr_url&quot;</span><span class="p">,</span>
                <span class="p">},</span>  <span class="c1"># added_sequence</span>
            <span class="p">},</span>
            <span class="c1"># loading additional sequences to the already exsisting core db</span>
            <span class="s2">&quot;load_additional_sequences&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
            <span class="c1"># size of the sequence data chunk, if 0 (default), no chunking is performed</span>
            <span class="s2">&quot;sequence_data_chunck&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
            <span class="c1">#   min size of the sequence chunk, no chunking is done if &#39;sequence_data_chunck&#39; &lt; &#39;sequence_data_chunck_min&#39;</span>
            <span class="s2">&quot;sequence_data_chunck_min_len&quot;</span><span class="p">:</span> <span class="mi">50_000</span><span class="p">,</span>
            <span class="c1"># coord system name for chunks</span>
            <span class="s2">&quot;chunk_cs_name&quot;</span><span class="p">:</span> <span class="s2">&quot;ensembl_internal&quot;</span><span class="p">,</span>
        <span class="p">}</span></div>

<div class="viewcode-block" id="load_sequence_data.run"><a class="viewcode-back" href="../../../../ensembl.brc4.runnable.html#ensembl.brc4.runnable.load_sequence_data.load_sequence_data.run">[docs]</a>    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Entry point for the Ehive module. All processing is done here in this case.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># params</span>
        <span class="n">work_dir</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">param_required</span><span class="p">(</span><span class="s2">&quot;work_dir&quot;</span><span class="p">)</span>

        <span class="c1"># initial sequence loading, using ensembl-analysis scripts</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">initial_sequence_loading</span><span class="p">(</span><span class="n">work_dir</span><span class="p">)</span>

        <span class="c1"># load data from the corresponding core db tables</span>
        <span class="n">external_db_map</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">load_map_from_core_db</span><span class="p">(</span>
            <span class="s2">&quot;external_db&quot;</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;db_name&quot;</span><span class="p">,</span> <span class="s2">&quot;external_db_id&quot;</span><span class="p">],</span> <span class="n">work_dir</span>
        <span class="p">)</span>  <span class="c1"># for external_db</span>
        <span class="n">attrib_type_map</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">load_map_from_core_db</span><span class="p">(</span>
            <span class="s2">&quot;attrib_type&quot;</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;code&quot;</span><span class="p">,</span> <span class="s2">&quot;attrib_type_id&quot;</span><span class="p">],</span> <span class="n">work_dir</span>
        <span class="p">)</span>  <span class="c1"># for attrib_type</span>
        <span class="n">seq_region_map</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">load_map_from_core_db</span><span class="p">(</span>
            <span class="s2">&quot;seq_region&quot;</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">,</span> <span class="s2">&quot;seq_region_id&quot;</span><span class="p">],</span> <span class="n">work_dir</span>
        <span class="p">)</span>  <span class="c1"># for seq_region</span>

        <span class="c1"># update synonyms and seq_region_attribs</span>
        <span class="n">unversion</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">param</span><span class="p">(</span><span class="s2">&quot;unversion_scaffolds&quot;</span><span class="p">)</span>
        <span class="n">is_primary_assembly</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">from_param</span><span class="p">(</span><span class="s2">&quot;manifest_data&quot;</span><span class="p">,</span> <span class="s2">&quot;agp&quot;</span><span class="p">,</span> <span class="n">not_throw</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">None</span>
        <span class="n">seq_region_file</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">from_param</span><span class="p">(</span><span class="s2">&quot;manifest_data&quot;</span><span class="p">,</span> <span class="s2">&quot;seq_region&quot;</span><span class="p">,</span> <span class="n">not_throw</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="c1">#   add seq_region synonyms</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_sr_synonyms</span><span class="p">(</span>
            <span class="n">seq_region_file</span><span class="p">,</span>
            <span class="n">seq_region_map</span><span class="p">,</span>
            <span class="n">external_db_map</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pjc</span><span class="p">(</span><span class="n">work_dir</span><span class="p">,</span> <span class="s2">&quot;seq_region_syns&quot;</span><span class="p">),</span>
            <span class="n">unversion</span><span class="o">=</span><span class="n">unversion</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="c1">#   add seq_region attributes</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_sr_attribs</span><span class="p">(</span>
            <span class="n">seq_region_file</span><span class="p">,</span>
            <span class="n">seq_region_map</span><span class="p">,</span>
            <span class="n">attrib_type_map</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pjc</span><span class="p">(</span><span class="n">work_dir</span><span class="p">,</span> <span class="s2">&quot;seq_region_attr&quot;</span><span class="p">),</span>
            <span class="n">unversion</span><span class="o">=</span><span class="n">unversion</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="c1">#   add seq_region EBI and BRC4 name attributes in the &quot;BRC4 mode&quot;</span>
        <span class="c1">#     special case of attributes adding with default values derived from seq_region names</span>
        <span class="c1">#     do not add if preparing to swap RefSeq and GeneBank ids; in this case attributes to be added at a later stage in pipeline</span>
        <span class="c1">#     (easier to insert then to update)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">param</span><span class="p">(</span><span class="s2">&quot;brc4_mode&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">param</span><span class="p">(</span><span class="s2">&quot;swap_gcf_gca&quot;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">add_sr_ebi_brc4_names</span><span class="p">(</span>
                <span class="n">seq_region_file</span><span class="p">,</span>
                <span class="n">seq_region_map</span><span class="p">,</span>
                <span class="n">attrib_type_map</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">pjc</span><span class="p">(</span><span class="n">work_dir</span><span class="p">,</span> <span class="s2">&quot;seq_region_ebi_brc4_name&quot;</span><span class="p">),</span>
                <span class="n">unversion</span><span class="o">=</span><span class="n">unversion</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="c1"># add karyotype related data</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_karyotype_data</span><span class="p">(</span>
            <span class="n">seq_region_file</span><span class="p">,</span>
            <span class="n">seq_region_map</span><span class="p">,</span>
            <span class="n">attrib_type_map</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pjc</span><span class="p">(</span><span class="n">work_dir</span><span class="p">,</span> <span class="s2">&quot;karyotype&quot;</span><span class="p">),</span>
            <span class="n">unversion</span><span class="o">=</span><span class="n">unversion</span><span class="p">,</span>
        <span class="p">)</span></div>

<div class="viewcode-block" id="load_sequence_data.initial_sequence_loading"><a class="viewcode-back" href="../../../../ensembl.brc4.runnable.html#ensembl.brc4.runnable.load_sequence_data.load_sequence_data.initial_sequence_loading">[docs]</a>    <span class="k">def</span> <span class="nf">initial_sequence_loading</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">work_dir</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        initial preparation and loading of AGPs and fasta data.</span>

<span class="sd">        initial preparation and loading of AGPs and fasta data using ensembl-analysis perl scripts</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># preprocess FASTA with sequences</span>
        <span class="c1">#   rename IUPAC to N symbols using sed</span>
        <span class="n">fasta_clean</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">from_param</span><span class="p">(</span><span class="s2">&quot;manifest_data&quot;</span><span class="p">,</span> <span class="s2">&quot;fasta_dna&quot;</span><span class="p">)</span>

        <span class="c1"># start coord system ranking and agps processing</span>
        <span class="n">agps</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">from_param</span><span class="p">(</span><span class="s2">&quot;manifest_data&quot;</span><span class="p">,</span> <span class="s2">&quot;agp&quot;</span><span class="p">,</span> <span class="n">not_throw</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="c1"># get the deafult coord_system order</span>
        <span class="c1">#   use noagp_cs_name_default for &quot;noagp&quot; assemblies</span>
        <span class="n">cs_order</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">coord_sys_order</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">param</span><span class="p">(</span><span class="s2">&quot;cs_order&quot;</span><span class="p">))</span>
        <span class="n">noagps_cs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">param</span><span class="p">(</span><span class="s2">&quot;noagp_cs_name_default&quot;</span><span class="p">)</span>

        <span class="c1"># remove gaps and lower_level mappings if the are coveres by higher level ones</span>
        <span class="c1">#   i.e.: remove &#39;contigN to chromosomeZ&#39;, if &#39;contigN to scaffoldM&#39; and &#39;scaffoldM to chromosomeZ&#39; are in place</span>
        <span class="c1">#   returns None if no agps provided</span>
        <span class="n">agps_pruned_dir</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pjc</span><span class="p">(</span><span class="n">work_dir</span><span class="p">,</span> <span class="s2">&quot;agps_pruned&quot;</span><span class="p">)</span>
        <span class="n">agps_pruned</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">prune_agps</span><span class="p">(</span><span class="n">agps</span><span class="p">,</span> <span class="n">cs_order</span><span class="p">,</span> <span class="n">agps_pruned_dir</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">param_bool</span><span class="p">(</span><span class="s2">&quot;prune_agp&quot;</span><span class="p">))</span>

        <span class="c1"># order</span>
        <span class="c1"># rank cs_names, met in agps.keys (&quot;-&quot; separated, i.e. &quot;scaffold-contig&quot;) based on cs_order</span>
        <span class="n">cs_rank</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">used_cs_ranks</span><span class="p">(</span><span class="n">agps_pruned</span><span class="p">,</span> <span class="n">cs_order</span><span class="p">,</span> <span class="n">noagps_cs</span><span class="p">)</span>

        <span class="c1"># chunk sequence data if needed</span>
        <span class="c1">#   no chunking if chunk_size &lt; 50k</span>
        <span class="n">chunk_size</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">param</span><span class="p">(</span><span class="s2">&quot;sequence_data_chunck&quot;</span><span class="p">))</span>
        <span class="n">chunk_cs_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">param</span><span class="p">(</span><span class="s2">&quot;chunk_cs_name&quot;</span><span class="p">)</span>
        <span class="n">fasta_clean</span><span class="p">,</span> <span class="n">cs_rank</span><span class="p">,</span> <span class="n">agps_pruned</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">chunk_contigs</span><span class="p">(</span>
            <span class="n">fasta_clean</span><span class="p">,</span>
            <span class="n">cs_rank</span><span class="p">,</span>
            <span class="n">agps_pruned</span><span class="p">,</span>
            <span class="n">pj</span><span class="p">(</span><span class="n">work_dir</span><span class="p">,</span> <span class="s2">&quot;chuncking&quot;</span><span class="p">),</span>
            <span class="n">chunk_size</span><span class="o">=</span><span class="n">chunk_size</span><span class="p">,</span>
            <span class="n">chunks_cs_name</span><span class="o">=</span><span class="n">chunk_cs_name</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="c1"># empty agps_pruned ignored</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">load_seq_data</span><span class="p">(</span><span class="n">fasta_clean</span><span class="p">,</span> <span class="n">agps_pruned</span><span class="p">,</span> <span class="n">cs_rank</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">pjc</span><span class="p">(</span><span class="n">work_dir</span><span class="p">,</span> <span class="s2">&quot;load&quot;</span><span class="p">))</span>

        <span class="c1"># mark all the &quot;contig&quot;s or noagp_cs as being sourced from ENA</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">param_bool</span><span class="p">(</span><span class="s2">&quot;no_contig_ena_attrib&quot;</span><span class="p">):</span>
            <span class="c1"># NB using original &quot;agps&quot; parameter (with no chuncking data added)</span>
            <span class="n">agps_raw</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">from_param</span><span class="p">(</span><span class="s2">&quot;manifest_data&quot;</span><span class="p">,</span> <span class="s2">&quot;agp&quot;</span><span class="p">,</span> <span class="n">not_throw</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">agps_raw</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">add_contig_ena_attrib</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pjc</span><span class="p">(</span><span class="n">work_dir</span><span class="p">,</span> <span class="s2">&quot;load&quot;</span><span class="p">,</span> <span class="s2">&quot;set_ena&quot;</span><span class="p">),</span> <span class="n">cs_name</span><span class="o">=</span><span class="n">noagps_cs</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">add_contig_ena_attrib</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pjc</span><span class="p">(</span><span class="n">work_dir</span><span class="p">,</span> <span class="s2">&quot;load&quot;</span><span class="p">,</span> <span class="s2">&quot;set_ena&quot;</span><span class="p">))</span>

        <span class="c1"># unversion scaffold, remove &quot;.\d$&quot; from names if there&#39;s a need</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">param_bool</span><span class="p">(</span><span class="s2">&quot;unversion_scaffolds&quot;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">unversion_scaffolds</span><span class="p">(</span><span class="n">cs_rank</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">pjc</span><span class="p">(</span><span class="n">work_dir</span><span class="p">,</span> <span class="s2">&quot;unversion_scaffolds&quot;</span><span class="p">))</span>

        <span class="c1"># add assembly mappings between various cs to meta table for the mapper to work properly</span>
        <span class="n">cs_pairs</span> <span class="o">=</span> <span class="n">agps_pruned</span> <span class="ow">and</span> <span class="n">agps_pruned</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="ow">or</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_asm_mappings</span><span class="p">(</span><span class="n">cs_pairs</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">pjc</span><span class="p">(</span><span class="n">work_dir</span><span class="p">,</span> <span class="s2">&quot;asm_mappings&quot;</span><span class="p">))</span>

        <span class="c1"># set toplevel seq_region attribute</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_toplevel</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pjc</span><span class="p">(</span><span class="n">work_dir</span><span class="p">,</span> <span class="s2">&quot;set_toplevel&quot;</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">param</span><span class="p">(</span><span class="s2">&quot;not_toplevel_cs&quot;</span><span class="p">))</span>

        <span class="c1"># nullify contig version and update mappings strings accordingly; ignore for &quot;load_additional_sequences&quot; mode</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">param_bool</span><span class="p">(</span><span class="s2">&quot;load_additional_sequences&quot;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">nullify_ctg_cs_version</span><span class="p">(</span><span class="n">cs_order</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">pjc</span><span class="p">(</span><span class="n">work_dir</span><span class="p">,</span> <span class="s2">&quot;asm_mapping&quot;</span><span class="p">,</span> <span class="s2">&quot;nullify_cs_versions&quot;</span><span class="p">))</span></div>

<div class="viewcode-block" id="load_sequence_data.add_sr_synonyms"><a class="viewcode-back" href="../../../../ensembl.brc4.runnable.html#ensembl.brc4.runnable.load_sequence_data.load_sequence_data.add_sr_synonyms">[docs]</a>    <span class="k">def</span> <span class="nf">add_sr_synonyms</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">seq_region_file</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">seq_region_map</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span>
        <span class="n">external_db_map</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span>
        <span class="n">work_dir</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">unversion</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">unversionable_sources_set</span><span class="p">:</span> <span class="nb">frozenset</span> <span class="o">=</span> <span class="nb">frozenset</span><span class="p">([</span><span class="s2">&quot;INSDC&quot;</span><span class="p">,</span> <span class="s2">&quot;RefSeq&quot;</span><span class="p">]),</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Add seq_region_synonym from the seq_region_file meta data file.</span>

<span class="sd">        Add seq_region_synonym from the schemas/seq_region_schema.json compatible meta data file.</span>
<span class="sd">        Merge with the already exinsting ones in the db.</span>

<span class="sd">        If unversion is true:</span>
<span class="sd">          * the unversioned synonym would be used to get the seq_region_id from &quot;seq_region_map&quot; if possible</span>
<span class="sd">          * the unversioned synonyms from the unversionable_sources_set will be added as well as the original ones</span>

<span class="sd">        Too close to the DB schema.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">work_dir</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="c1"># return if there&#39;s nothing to add</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">seq_region_file</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="c1"># get seq_region ids, names, syns from db</span>
        <span class="n">synonyms_trios_db</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">load_seq_region_synonyms_trios_from_core_db</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pjc</span><span class="p">(</span><span class="n">work_dir</span><span class="p">,</span> <span class="s2">&quot;syns_from_core&quot;</span><span class="p">)</span>
        <span class="p">)</span>

        <span class="c1"># form set of synonyms already present in db</span>
        <span class="n">synonyms_in_db</span> <span class="o">=</span> <span class="nb">frozenset</span><span class="p">([</span><span class="n">trio</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="k">for</span> <span class="n">trio</span> <span class="ow">in</span> <span class="n">synonyms_trios_db</span> <span class="k">if</span> <span class="n">trio</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">!=</span> <span class="s2">&quot;NULL&quot;</span><span class="p">])</span>

        <span class="c1"># subset of sources to use the allowed the unversion synonyms</span>
        <span class="n">unversionable_sources</span> <span class="o">=</span> <span class="n">unversion</span> <span class="ow">and</span> <span class="n">unversionable_sources_set</span> <span class="ow">or</span> <span class="nb">frozenset</span><span class="p">()</span>

        <span class="c1"># technical / optimization. get external_db_id for &quot;ensembl_internal_synonym&quot;</span>
        <span class="n">ensembl_internal_synonym_ext_db_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">id_from_map_or_die</span><span class="p">(</span>
            <span class="s2">&quot;ensembl_internal_synonym&quot;</span><span class="p">,</span> <span class="n">external_db_map</span><span class="p">,</span> <span class="s2">&quot;external_db_map&quot;</span>
        <span class="p">)</span>

        <span class="c1"># get dict for additional mapping for sources to external_db names if there&#39;s one specified by &quot;external_db_map&quot; module param</span>
        <span class="c1">#   not to be confused with the external_db_map function parameter above</span>
        <span class="n">additional_sources_mapping</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_external_db_mapping</span><span class="p">()</span>

        <span class="c1"># load synonyms from the json file</span>
        <span class="n">synonyms_from_json</span> <span class="o">=</span> <span class="p">(</span>
            <span class="p">[]</span>
        <span class="p">)</span>  <span class="c1"># [ (seq_region_id, synonym, external_db_id)... ] list of trios for inserting into db</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">seq_region_file</span><span class="p">)</span> <span class="k">as</span> <span class="n">in_file</span><span class="p">:</span>
            <span class="n">seq_regions</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">in_file</span><span class="p">))</span>
            <span class="k">for</span> <span class="n">seq_region</span> <span class="ow">in</span> <span class="nb">filter</span><span class="p">(</span><span class="k">lambda</span> <span class="n">sr</span><span class="p">:</span> <span class="n">sr</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;synonyms&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">),</span> <span class="n">seq_regions</span><span class="p">):</span>
                <span class="c1"># iterate through all seq_regions having &quot;synonyms&quot;</span>
                <span class="n">seq_region_name</span><span class="p">,</span> <span class="n">seq_region_id</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">name_and_id_from_seq_region_item</span><span class="p">(</span>
                    <span class="n">seq_region</span><span class="p">,</span> <span class="n">seq_region_map</span><span class="p">,</span> <span class="n">try_unversion</span><span class="o">=</span><span class="n">unversion</span>
                <span class="p">)</span>

                <span class="c1"># fill synonyms_from_json list of trios</span>
                <span class="k">for</span> <span class="n">synonym_item</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">seq_region</span><span class="p">[</span><span class="s2">&quot;synonyms&quot;</span><span class="p">]):</span>
                    <span class="n">synonym_name</span> <span class="o">=</span> <span class="n">synonym_item</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span>
                    <span class="n">source</span> <span class="o">=</span> <span class="n">synonym_item</span><span class="p">[</span><span class="s2">&quot;source&quot;</span><span class="p">]</span>
                    <span class="n">unversioned_name</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>

                    <span class="c1"># check if there&#39;s any addtional mapping for the source, remap if so</span>
                    <span class="k">if</span> <span class="n">additional_sources_mapping</span><span class="p">:</span>
                        <span class="n">source</span> <span class="o">=</span> <span class="n">additional_sources_mapping</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                            <span class="n">source</span><span class="p">,</span> <span class="n">source</span>
                        <span class="p">)</span>  <span class="c1"># use the same name if no matches in additional_sources_mapping dict</span>

                    <span class="c1"># try to get unversioned name if applicable</span>
                    <span class="k">if</span> <span class="n">source</span> <span class="ow">in</span> <span class="n">unversionable_sources</span><span class="p">:</span>
                        <span class="n">unversioned_name</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;\.\d+$&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">synonym_name</span><span class="p">)</span>

                    <span class="c1"># put trios if names are not already seen in db</span>
                    <span class="k">if</span> <span class="n">synonym_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">synonyms_in_db</span><span class="p">:</span>
                        <span class="n">external_db_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">id_from_map_or_die</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">external_db_map</span><span class="p">,</span> <span class="s2">&quot;external_db_map&quot;</span><span class="p">)</span>
                        <span class="n">synonyms_from_json</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                            <span class="p">(</span><span class="n">seq_region_id</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">quote_or_null</span><span class="p">(</span><span class="n">synonym_name</span><span class="p">),</span> <span class="n">external_db_id</span><span class="p">)</span>
                        <span class="p">)</span>

                    <span class="c1">#   put additional unversioned synonyms if there&#39;s a sane one</span>
                    <span class="k">if</span> <span class="p">(</span>
                        <span class="n">unversioned_name</span>
                        <span class="ow">and</span> <span class="n">unversioned_name</span> <span class="o">!=</span> <span class="n">synonym_name</span>
                        <span class="ow">and</span> <span class="n">unversioned_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">synonyms_in_db</span>
                    <span class="p">):</span>
                        <span class="n">synonyms_from_json</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                            <span class="p">(</span>
                                <span class="n">seq_region_id</span><span class="p">,</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">quote_or_null</span><span class="p">(</span><span class="n">unversioned_name</span><span class="p">),</span>
                                <span class="n">ensembl_internal_synonym_ext_db_id</span><span class="p">,</span>
                            <span class="p">)</span>
                        <span class="p">)</span>

        <span class="c1"># run insertion SQL</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">insert_to_db</span><span class="p">(</span>
            <span class="n">synonyms_from_json</span><span class="p">,</span>
            <span class="s2">&quot;seq_region_synonym&quot;</span><span class="p">,</span>
            <span class="p">[</span><span class="s2">&quot;seq_region_id&quot;</span><span class="p">,</span> <span class="s2">&quot;synonym&quot;</span><span class="p">,</span> <span class="s2">&quot;external_db_id&quot;</span><span class="p">],</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pjc</span><span class="p">(</span><span class="n">work_dir</span><span class="p">,</span> <span class="s2">&quot;new_seq_region_synonyms&quot;</span><span class="p">),</span>
            <span class="n">ignore</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="p">)</span></div>

<div class="viewcode-block" id="load_sequence_data.add_sr_attribs"><a class="viewcode-back" href="../../../../ensembl.brc4.runnable.html#ensembl.brc4.runnable.load_sequence_data.load_sequence_data.add_sr_attribs">[docs]</a>    <span class="k">def</span> <span class="nf">add_sr_attribs</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">seq_region_file</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">seq_region_map</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span>
        <span class="n">attrib_type_map</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span>
        <span class="n">work_dir</span><span class="p">,</span>
        <span class="n">unversion</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Add seq_region_attrib(s) from the seq_region_file meta data file.</span>

<span class="sd">        Explicit list is taken from &quot;sr_attrib_types&quot; module param.</span>

<span class="sd">        Add seq_region_attrib(s) from the schemas/seq_region_schema.json compatible meta data file.</span>
<span class="sd">        Explicit list is taken from &quot;sr_attrib_types&quot; module param.</span>

<span class="sd">        &quot;sr_attrib_types&quot; defines { json_property -&gt; attrib_type.name } map. If the value is dict,</span>
<span class="sd">        its keys are treated as &quot;/&quot;-delimetered &quot;json_path&quot; (i.e. &quot;added_sequence/assembly_provider/name&quot;).</span>
<span class="sd">        No arrays can be processed. Only simple or &quot;flattable&quot; types.</span>

<span class="sd">        If unversion is true:</span>
<span class="sd">          * the unversioned synonym would be used to get the seq_region_id from &quot;seq_region_map&quot; if possible</span>

<span class="sd">        Too close to the DB schema.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">work_dir</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="c1"># return if there&#39;s nothing to add</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">seq_region_file</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="c1"># technical / optimization. get atttib_type_id(s)</span>
        <span class="c1"># create a smaller map with attrib_type_id(s) as values</span>
        <span class="n">properties_to_use</span> <span class="o">=</span> <span class="p">(</span>
            <span class="p">[]</span>
        <span class="p">)</span>  <span class="c1"># [frozen]set with the top-level &quot;seq_region&quot; properties, that should be processed</span>
        <span class="n">path_attrib_id_map</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>  <span class="c1"># { &quot;flatterned/json/paths&quot; : attrib_id_map ))}</span>
        <span class="c1"># fill set and map</span>
        <span class="k">for</span> <span class="n">prop</span><span class="p">,</span> <span class="n">attrib_type</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">param</span><span class="p">(</span><span class="s2">&quot;sr_attrib_types&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="c1"># adding high level properties to process</span>
            <span class="n">properties_to_use</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">prop</span><span class="p">)</span>
            <span class="c1"># adding json paths (or properties themselves) to atrrib_type_id map</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">attrib_type</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>  <span class="c1"># if using json paths (delimeterd with &quot;/&quot;)</span>
                <span class="k">for</span> <span class="n">path</span><span class="p">,</span> <span class="n">inner_attrib_type</span> <span class="ow">in</span> <span class="n">attrib_type</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="n">path_attrib_id_map</span><span class="p">[</span><span class="n">path</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">id_from_map_or_die</span><span class="p">(</span>
                        <span class="n">inner_attrib_type</span><span class="p">,</span> <span class="n">attrib_type_map</span><span class="p">,</span> <span class="s2">&quot;attrib_type_map&quot;</span>
                    <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">path_attrib_id_map</span><span class="p">[</span><span class="n">prop</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">id_from_map_or_die</span><span class="p">(</span>
                    <span class="n">attrib_type</span><span class="p">,</span> <span class="n">attrib_type_map</span><span class="p">,</span> <span class="s2">&quot;attrib_type_map&quot;</span>
                <span class="p">)</span>
        <span class="c1"># return if there&#39;s nothing to add</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">properties_to_use</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="n">properties_to_use</span> <span class="o">=</span> <span class="nb">frozenset</span><span class="p">(</span><span class="n">properties_to_use</span><span class="p">)</span>

        <span class="c1"># load attributes from seq_region file</span>
        <span class="n">attrib_trios</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># [ (seq_region_id, attrib_id, value)... ] list of trios for inserting into db</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">seq_region_file</span><span class="p">)</span> <span class="k">as</span> <span class="n">in_file</span><span class="p">:</span>
            <span class="n">seq_regions</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">in_file</span><span class="p">))</span>
            <span class="k">for</span> <span class="n">seq_region</span> <span class="ow">in</span> <span class="n">seq_regions</span><span class="p">:</span>
                <span class="c1"># get seq_region_id (perhaps, by using unversioned name)</span>
                <span class="n">seq_region_name</span><span class="p">,</span> <span class="n">seq_region_id</span><span class="p">,</span> <span class="n">unversioned_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">name_and_id_from_seq_region_item</span><span class="p">(</span>
                    <span class="n">seq_region</span><span class="p">,</span> <span class="n">seq_region_map</span><span class="p">,</span> <span class="n">try_unversion</span><span class="o">=</span><span class="n">unversion</span>
                <span class="p">)</span>

                <span class="c1"># iterate through properties</span>
                <span class="k">for</span> <span class="n">prop_name</span> <span class="ow">in</span> <span class="n">properties_to_use</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">prop_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">seq_region</span><span class="p">:</span>
                        <span class="k">continue</span>
                    <span class="c1"># flattern path</span>
                    <span class="n">path_attrib_id_values_list</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">flattern_seq_region_item</span><span class="p">(</span>
                        <span class="n">seq_region</span><span class="p">,</span> <span class="n">prop_name</span><span class="p">,</span> <span class="n">path_attrib_id_map</span>
                    <span class="p">)</span>
                    <span class="c1"># fill attrib_trios</span>
                    <span class="k">for</span> <span class="n">path</span><span class="p">,</span> <span class="n">attrib_id</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">path_attrib_id_values_list</span><span class="p">:</span>
                        <span class="n">attrib_trios</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">seq_region_id</span><span class="p">,</span> <span class="n">attrib_id</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">quote_or_null</span><span class="p">(</span><span class="n">value</span><span class="p">)))</span>

        <span class="c1"># run insertion SQL</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">insert_to_db</span><span class="p">(</span>
            <span class="n">attrib_trios</span><span class="p">,</span>
            <span class="s2">&quot;seq_region_attrib&quot;</span><span class="p">,</span>
            <span class="p">[</span><span class="s2">&quot;seq_region_id&quot;</span><span class="p">,</span> <span class="s2">&quot;attrib_type_id&quot;</span><span class="p">,</span> <span class="s2">&quot;value&quot;</span><span class="p">],</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pjc</span><span class="p">(</span><span class="n">work_dir</span><span class="p">,</span> <span class="s2">&quot;brc4_ebi_seq_region_synonyms&quot;</span><span class="p">),</span>
            <span class="n">ignore</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="p">)</span></div>

<div class="viewcode-block" id="load_sequence_data.flattern_seq_region_item"><a class="viewcode-back" href="../../../../ensembl.brc4.runnable.html#ensembl.brc4.runnable.load_sequence_data.load_sequence_data.flattern_seq_region_item">[docs]</a>    <span class="k">def</span> <span class="nf">flattern_seq_region_item</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">seq_region</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">prop_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">path_attrib_id_map</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">sep</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;/&quot;</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Flattern seq_region[property] and store corresponding [ (json_path, attrib_id, value)... ] (as list of trios).</span>

<span class="sd">        Only works for simple properties or dicts with no arrays on the path. Basically, implemets tree traversal.</span>
<span class="sd">        Utility function used by the `add_sr_attribs` method</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">res</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="c1"># is there anything to do</span>
        <span class="k">if</span> <span class="n">prop_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">seq_region</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">res</span>

        <span class="c1"># set up</span>
        <span class="n">value</span> <span class="o">=</span> <span class="n">seq_region</span><span class="p">[</span><span class="n">prop_name</span><span class="p">]</span>
        <span class="n">paths_to_go</span> <span class="o">=</span> <span class="p">[</span>
            <span class="p">(</span><span class="n">prop_name</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
        <span class="p">]</span>  <span class="c1"># storing path and the corresponding value, to prevent repetetive traversals</span>
        <span class="c1"># iterate</span>
        <span class="k">while</span> <span class="n">paths_to_go</span><span class="p">:</span>
            <span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span> <span class="o">=</span> <span class="n">paths_to_go</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>  <span class="c1"># get last item</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                <span class="c1"># perhaps, it&#39;s better to raise exception then to continue silently</span>
                <span class="k">continue</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
                <span class="c1"># if value is a complex object, add its leaves</span>
                <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">value</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="n">paths_to_go</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">path</span><span class="si">}{</span><span class="n">sep</span><span class="si">}{</span><span class="n">key</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">val</span><span class="p">))</span>
                <span class="k">continue</span>
            <span class="c1"># if value is simple</span>
            <span class="n">attrib_id</span> <span class="o">=</span> <span class="n">path_attrib_id_map</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">attrib_id</span><span class="p">:</span>
                <span class="n">res</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">path</span><span class="p">,</span> <span class="n">attrib_id</span><span class="p">,</span> <span class="n">value</span><span class="p">))</span>
        <span class="c1"># return what ever we have</span>
        <span class="k">return</span> <span class="n">res</span></div>

<div class="viewcode-block" id="load_sequence_data.add_sr_ebi_brc4_names"><a class="viewcode-back" href="../../../../ensembl.brc4.runnable.html#ensembl.brc4.runnable.load_sequence_data.load_sequence_data.add_sr_ebi_brc4_names">[docs]</a>    <span class="k">def</span> <span class="nf">add_sr_ebi_brc4_names</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">seq_region_file</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">seq_region_map</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span>
        <span class="n">attrib_type_map</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span>
        <span class="n">work_dir</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">unversion</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Add &quot;(EBI|BRC4)_seq_region_name&quot; seq_region_attrib(s) either from the seq_region_file meta data file, or from original seq_region names.</span>

<span class="sd">        Add &quot;(EBI|BRC4)_seq_region_name&quot; seq_region_synonym from the schemas/seq_region_schema.json compatible meta data file or from the original seq_region_names.</span>
<span class="sd">        A special case of attributes adding with default values derived from seq_region names.</span>

<span class="sd">        If unversion is true:</span>
<span class="sd">          * the unversioned synonym would be used to get the seq_region_id from &quot;seq_region_map&quot; if possible</span>

<span class="sd">        Too close to the DB schema.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">work_dir</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="c1"># return if there&#39;s nothing to add</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">seq_region_file</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="c1"># technical / optimization. get atttib_type_id(s) for &quot;(EBI|BRC4)_seq_region_name&quot;</span>
        <span class="n">tagged_sr_name_attrib_id</span> <span class="o">=</span> <span class="p">{</span>
            <span class="n">tag</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">id_from_map_or_die</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">tag</span><span class="si">}</span><span class="s2">_seq_region_name&quot;</span><span class="p">,</span> <span class="n">attrib_type_map</span><span class="p">,</span> <span class="s2">&quot;attrib_type_map&quot;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">tag</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;EBI&quot;</span><span class="p">,</span> <span class="s2">&quot;BRC4&quot;</span><span class="p">]</span>
        <span class="p">}</span>

        <span class="c1"># load BRC4/EBI name from seq_region file</span>
        <span class="n">brc4_ebi_name_attrib_trios</span> <span class="o">=</span> <span class="p">(</span>
            <span class="p">[]</span>
        <span class="p">)</span>  <span class="c1"># [ (seq_region_id, attrib_id, value)... ] list of trios for inserting into db</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">seq_region_file</span><span class="p">)</span> <span class="k">as</span> <span class="n">in_file</span><span class="p">:</span>
            <span class="n">seq_regions</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">in_file</span><span class="p">))</span>
            <span class="k">for</span> <span class="n">seq_region</span> <span class="ow">in</span> <span class="n">seq_regions</span><span class="p">:</span>
                <span class="c1"># get seq_region_id (perhaps, by using unversioned name)</span>
                <span class="n">seq_region_name</span><span class="p">,</span> <span class="n">seq_region_id</span><span class="p">,</span> <span class="n">unversioned_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">name_and_id_from_seq_region_item</span><span class="p">(</span>
                    <span class="n">seq_region</span><span class="p">,</span> <span class="n">seq_region_map</span><span class="p">,</span> <span class="n">try_unversion</span><span class="o">=</span><span class="n">unversion</span>
                <span class="p">)</span>
                <span class="c1"># append attribs to the brc4_ebi_name_attrib_trios list</span>
                <span class="k">for</span> <span class="n">tag</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;BRC4&quot;</span><span class="p">,</span> <span class="s2">&quot;EBI&quot;</span><span class="p">]:</span>
                    <span class="n">attrib_name</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">tag</span><span class="si">}</span><span class="s2">_seq_region_name&quot;</span>
                    <span class="n">attrib_id</span> <span class="o">=</span> <span class="n">tagged_sr_name_attrib_id</span><span class="p">[</span><span class="n">tag</span><span class="p">]</span>
                    <span class="n">value</span> <span class="o">=</span> <span class="n">seq_region</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">attrib_name</span><span class="p">,</span> <span class="n">seq_region_name</span><span class="p">)</span>
                    <span class="n">brc4_ebi_name_attrib_trios</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">seq_region_id</span><span class="p">,</span> <span class="n">attrib_id</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">quote_or_null</span><span class="p">(</span><span class="n">value</span><span class="p">)))</span>

        <span class="c1"># run insertion SQL</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">insert_to_db</span><span class="p">(</span>
            <span class="n">brc4_ebi_name_attrib_trios</span><span class="p">,</span>
            <span class="s2">&quot;seq_region_attrib&quot;</span><span class="p">,</span>
            <span class="p">[</span><span class="s2">&quot;seq_region_id&quot;</span><span class="p">,</span> <span class="s2">&quot;attrib_type_id&quot;</span><span class="p">,</span> <span class="s2">&quot;value&quot;</span><span class="p">],</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pjc</span><span class="p">(</span><span class="n">work_dir</span><span class="p">,</span> <span class="s2">&quot;brc4_ebi_seq_region_synonyms&quot;</span><span class="p">),</span>
            <span class="n">ignore</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="p">)</span></div>

<div class="viewcode-block" id="load_sequence_data.add_karyotype_data"><a class="viewcode-back" href="../../../../ensembl.brc4.runnable.html#ensembl.brc4.runnable.load_sequence_data.load_sequence_data.add_karyotype_data">[docs]</a>    <span class="k">def</span> <span class="nf">add_karyotype_data</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">seq_region_file</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">seq_region_map</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span>
        <span class="n">attrib_type_map</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span>
        <span class="n">work_dir</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">unversion</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Adds various karyotypic data from seq_region file and assembly metadata (if present).</span>

<span class="sd">        Adds various karyotypic data from the schemas/seq_region_schema.json compatible meta data file and assembly metadata (if present).</span>

<span class="sd">        If unversion is true:</span>
<span class="sd">          * the unversioned synonym would be used to get the seq_region_id from &quot;seq_region_map&quot; if possible</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># add karyotyope bands data</span>
        <span class="n">regions_with_karyotype_bands</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">add_karyotype_bands</span><span class="p">(</span>
            <span class="n">seq_region_file</span><span class="p">,</span>
            <span class="n">seq_region_map</span><span class="p">,</span>
            <span class="n">attrib_type_map</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pjc</span><span class="p">(</span><span class="n">work_dir</span><span class="p">,</span> <span class="s2">&quot;karyotype_bands&quot;</span><span class="p">),</span>
            <span class="n">unversion</span><span class="o">=</span><span class="n">unversion</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="c1"># try to add karyotype ranks for regions listed in genome_data/assembly/chromosome_display_order metadata</span>
        <span class="n">regions_with_ranks_from_assembly_metadata</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">add_karyotype_rank_based_on_assembly_metadata</span><span class="p">(</span>
            <span class="n">seq_region_map</span><span class="p">,</span>
            <span class="n">attrib_type_map</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pjc</span><span class="p">(</span><span class="n">work_dir</span><span class="p">,</span> <span class="s2">&quot;karyotype_ranks_from_meta&quot;</span><span class="p">),</span>
            <span class="n">unversion</span><span class="o">=</span><span class="n">unversion</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="n">regions_with_ranks_from_chromosome_cs</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">regions_with_ranks_from_assembly_metadata</span><span class="p">:</span>
            <span class="c1"># try to add karyotype_ranks for top-level regions from the &quot;chromosome&quot; coord_system</span>
            <span class="n">regions_with_ranks_from_chromosome_cs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">add_karyotype_rank_for_chromosomes</span><span class="p">(</span>
                <span class="n">attrib_type_map</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">pjc</span><span class="p">(</span><span class="n">work_dir</span><span class="p">,</span> <span class="s2">&quot;karyotype_ranks_for_chromosomes&quot;</span><span class="p">)</span>
            <span class="p">)</span>

        <span class="c1"># make sure that regions with bands have karyotype_ranks</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_karyotype_rank_from_bands_info</span><span class="p">(</span>
            <span class="n">regions_with_karyotype_bands</span><span class="p">,</span>
            <span class="n">regions_with_ranks_from_chromosome_cs</span> <span class="o">+</span> <span class="n">regions_with_ranks_from_assembly_metadata</span><span class="p">,</span>
            <span class="n">attrib_type_map</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pjc</span><span class="p">(</span><span class="n">work_dir</span><span class="p">,</span> <span class="s2">&quot;karyotype_ranks_from_bands&quot;</span><span class="p">),</span>
        <span class="p">)</span></div>

<div class="viewcode-block" id="load_sequence_data.add_karyotype_bands"><a class="viewcode-back" href="../../../../ensembl.brc4.runnable.html#ensembl.brc4.runnable.load_sequence_data.load_sequence_data.add_karyotype_bands">[docs]</a>    <span class="k">def</span> <span class="nf">add_karyotype_bands</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">seq_region_file</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">seq_region_map</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span>
        <span class="n">attrib_type_map</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span>
        <span class="n">work_dir</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">unversion</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">karyotype_bands_property</span><span class="o">=</span><span class="s2">&quot;karyotype_bands&quot;</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">:</span>  <span class="c1"># [ (seq_region_name, seq_region_id, unversioned_name) ]</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Add karyotypic data from the seq_region metafile.</span>

<span class="sd">        Add karyotypic data from the schemas/seq_region_schema.json compatible meta data file.</span>
<span class="sd">        Returns list of [ (seq_region_name, seq_region_id, unversioned_name) ] trios for seq_regions having karyotype bands info.</span>

<span class="sd">        If unversion is true:</span>
<span class="sd">          * the unversioned synonym would be used to get the seq_region_id from &quot;seq_region_map&quot; if possible</span>

<span class="sd">        Too close to the DB schema.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">work_dir</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="c1"># return if there&#39;s nothing to add</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">seq_region_file</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="c1"># resulting list of seq regions with bands</span>
        <span class="n">seq_regions_with_karyotype_bands</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># [ ( seq_region_name, seq_region_id, unversioned_name )... ]</span>

        <span class="c1"># load BRC4/EBI name from seq_region file</span>
        <span class="n">band_tuples</span> <span class="o">=</span> <span class="p">(</span>
            <span class="p">[]</span>
        <span class="p">)</span>  <span class="c1"># [ (seq_region_id, seq_region_start, seq_region_end, band|&quot;NULL&quot;, stain|&quot;NULL&quot;)... ] list of tuples for inserting into db</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">seq_region_file</span><span class="p">)</span> <span class="k">as</span> <span class="n">in_file</span><span class="p">:</span>
            <span class="n">seq_regions</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">in_file</span><span class="p">))</span>
            <span class="k">for</span> <span class="n">seq_region</span> <span class="ow">in</span> <span class="nb">filter</span><span class="p">(</span><span class="k">lambda</span> <span class="n">sr</span><span class="p">:</span> <span class="n">sr</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">karyotype_bands_property</span><span class="p">,</span> <span class="kc">False</span><span class="p">),</span> <span class="n">seq_regions</span><span class="p">):</span>
                <span class="c1"># iterate through all seq_regions having non-empty &quot;karyotype_bands&quot;</span>

                <span class="c1"># get seq_region_id (perhaps, by using unversioned name)</span>
                <span class="n">seq_region_name</span><span class="p">,</span> <span class="n">seq_region_id</span><span class="p">,</span> <span class="n">unversioned_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">name_and_id_from_seq_region_item</span><span class="p">(</span>
                    <span class="n">seq_region</span><span class="p">,</span> <span class="n">seq_region_map</span><span class="p">,</span> <span class="n">try_unversion</span><span class="o">=</span><span class="n">unversion</span>
                <span class="p">)</span>

                <span class="c1"># append trio to the resulting list</span>
                <span class="n">seq_regions_with_karyotype_bands</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">seq_region_name</span><span class="p">,</span> <span class="n">seq_region_id</span><span class="p">,</span> <span class="n">unversioned_name</span><span class="p">))</span>

                <span class="c1"># append bands to the band_tuples list</span>
                <span class="k">for</span> <span class="n">band</span> <span class="ow">in</span> <span class="n">seq_region</span><span class="p">[</span><span class="n">karyotype_bands_property</span><span class="p">]:</span>
                    <span class="c1"># print(&quot;BAND: &quot; + str(band), file = sys.stderr)</span>
                    <span class="c1"># coords</span>
                    <span class="n">seq_region_start</span> <span class="o">=</span> <span class="n">band</span><span class="p">[</span><span class="s2">&quot;start&quot;</span><span class="p">]</span>
                    <span class="n">seq_region_end</span> <span class="o">=</span> <span class="n">band</span><span class="p">[</span><span class="s2">&quot;end&quot;</span><span class="p">]</span>
                    <span class="c1"># band_name and stain</span>
                    <span class="n">band_name</span> <span class="o">=</span> <span class="n">band</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;name&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                    <span class="n">stain</span> <span class="o">=</span> <span class="n">band</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;stain&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                    <span class="c1"># special cases for stain</span>
                    <span class="n">structure</span> <span class="o">=</span> <span class="n">band</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;structure&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">structure</span> <span class="o">==</span> <span class="s2">&quot;telomere&quot;</span><span class="p">:</span>
                        <span class="n">stain</span> <span class="o">=</span> <span class="s2">&quot;TEL&quot;</span>
                    <span class="k">elif</span> <span class="n">structure</span> <span class="o">==</span> <span class="s2">&quot;centromere&quot;</span><span class="p">:</span>
                        <span class="n">stain</span> <span class="o">=</span> <span class="s2">&quot;ACEN&quot;</span>

                    <span class="c1"># append tuple</span>
                    <span class="n">band_tuples</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                        <span class="p">(</span>
                            <span class="n">seq_region_id</span><span class="p">,</span>
                            <span class="n">seq_region_start</span><span class="p">,</span>
                            <span class="n">seq_region_end</span><span class="p">,</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">quote_or_null</span><span class="p">(</span><span class="n">band_name</span><span class="p">),</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">quote_or_null</span><span class="p">(</span><span class="n">stain</span><span class="p">),</span>
                        <span class="p">)</span>
                    <span class="p">)</span>

        <span class="c1"># run insertion SQL</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">insert_to_db</span><span class="p">(</span>
            <span class="n">band_tuples</span><span class="p">,</span>
            <span class="s2">&quot;karyotype&quot;</span><span class="p">,</span>
            <span class="p">[</span><span class="s2">&quot;seq_region_id&quot;</span><span class="p">,</span> <span class="s2">&quot;seq_region_start&quot;</span><span class="p">,</span> <span class="s2">&quot;seq_region_end&quot;</span><span class="p">,</span> <span class="s2">&quot;band&quot;</span><span class="p">,</span> <span class="s2">&quot;stain&quot;</span><span class="p">],</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pjc</span><span class="p">(</span><span class="n">work_dir</span><span class="p">,</span> <span class="s2">&quot;karyotype_insertion&quot;</span><span class="p">),</span>
            <span class="n">ignore</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="c1"># return resulting list of regions with bands trios</span>
        <span class="k">return</span> <span class="n">seq_regions_with_karyotype_bands</span></div>

<div class="viewcode-block" id="load_sequence_data.add_karyotype_rank_based_on_assembly_metadata"><a class="viewcode-back" href="../../../../ensembl.brc4.runnable.html#ensembl.brc4.runnable.load_sequence_data.load_sequence_data.add_karyotype_rank_based_on_assembly_metadata">[docs]</a>    <span class="k">def</span> <span class="nf">add_karyotype_rank_based_on_assembly_metadata</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">seq_region_map</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">attrib_type_map</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">work_dir</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">unversion</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">:</span>  <span class="c1"># [ (seq_region_name, seq_region_id, unversioned_name) ]</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Add `karyotype_rank` attributes for seq region data from based on metadata from the &quot;genome_data&quot; module parameter.</span>
<span class="sd">        Add only to the seq_regions with ids listed in the array corresponding to &#39;genome_data/assembly/chromosome_display_order&#39;.</span>

<span class="sd">        Set &quot;coord_system_tag&quot; attribute to the one listed in the &quot;cs_tag_for_ordered&quot; module param; or &quot;chromosome&quot; if param value is underfined.</span>
<span class="sd">        Force updating of the &quot;coord_system_tags&quot; if `force_update_coord_system_tag` module param is True.</span>

<span class="sd">        Returns list of [ (seq_region_name, seq_region_id, unversioned_name) ] trios for seq_regions with updated karyotype_ranks.</span>

<span class="sd">        If unversion is true:</span>
<span class="sd">          * the unversioned synonym would be used to get the seq_region_id from &quot;seq_region_map&quot; if possible</span>

<span class="sd">        Too close to the DB schema.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># resulting list of seq_region with karyotype_rank</span>
        <span class="n">regions_with_ranks_from_assembly_metadata</span> <span class="o">=</span> <span class="p">(</span>
            <span class="p">[]</span>
        <span class="p">)</span>  <span class="c1"># [ ( seq_region_name, seq_region_id, unversioned_name )... ]</span>

        <span class="c1"># get `chromosome_display_order` list from the assembly metadata</span>
        <span class="n">assembly_metadata</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">from_param</span><span class="p">(</span><span class="s2">&quot;genome_data&quot;</span><span class="p">,</span> <span class="s2">&quot;assembly&quot;</span><span class="p">,</span> <span class="n">not_throw</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="n">chromosome_display_order_list</span> <span class="o">=</span> <span class="n">assembly_metadata</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;chromosome_display_order&quot;</span><span class="p">,</span> <span class="p">[])</span>

        <span class="c1"># technical / optimization. get external_db_id for &quot;karyotype_rank&quot; and &quot;coord_system_tag&quot;</span>
        <span class="n">karyotype_rank_attrib_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">id_from_map_or_die</span><span class="p">(</span>
            <span class="s2">&quot;karyotype_rank&quot;</span><span class="p">,</span> <span class="n">attrib_type_map</span><span class="p">,</span> <span class="s2">&quot;attrib_type_map&quot;</span>
        <span class="p">)</span>
        <span class="n">coord_system_tag_attrib_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">id_from_map_or_die</span><span class="p">(</span>
            <span class="s2">&quot;coord_system_tag&quot;</span><span class="p">,</span> <span class="n">attrib_type_map</span><span class="p">,</span> <span class="s2">&quot;attrib_type_map&quot;</span>
        <span class="p">)</span>
        <span class="n">coord_system_tag</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">param</span><span class="p">(</span><span class="s2">&quot;cs_tag_for_ordered&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="s2">&quot;chromosome&quot;</span>
        <span class="n">force_update_coord_system_tag</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">param</span><span class="p">(</span><span class="s2">&quot;force_update_coord_system_tag&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="kc">False</span>

        <span class="c1"># set/update proper attributes for `chromosome_display_order_list` regions</span>
        <span class="n">rank_insertions_trios</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">coord_system_tag_attrib_insertion_trios</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">coord_system_tag_attrib_seq_region_update_ids</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">seq_region_name_raw</span> <span class="ow">in</span> <span class="n">chromosome_display_order_list</span><span class="p">:</span>
            <span class="c1"># wrap seq_region_name_raw into seq_region struct { &quot;name&quot;: seq_region_name_raw } and</span>
            <span class="c1"># get seq_region_id (perhaps, by using unversioned name)</span>
            <span class="n">seq_region_name</span><span class="p">,</span> <span class="n">seq_region_id</span><span class="p">,</span> <span class="n">unversioned_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">name_and_id_from_seq_region_item</span><span class="p">(</span>
                <span class="p">{</span><span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="n">seq_region_name_raw</span><span class="p">},</span> <span class="n">seq_region_map</span><span class="p">,</span> <span class="n">try_unversion</span><span class="o">=</span><span class="n">unversion</span>
            <span class="p">)</span>

            <span class="c1"># append trio to the resulting list</span>
            <span class="n">regions_with_ranks_from_assembly_metadata</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="p">(</span><span class="n">seq_region_name</span><span class="p">,</span> <span class="n">seq_region_id</span><span class="p">,</span> <span class="n">unversioned_name</span><span class="p">)</span>
            <span class="p">)</span>

            <span class="c1"># filling insert lists for &quot;karyotype_rank&quot; and &quot;coord_system_tag&quot; attributes</span>
            <span class="n">rank_insertions_trios</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="p">(</span><span class="n">seq_region_id</span><span class="p">,</span> <span class="n">karyotype_rank_attrib_id</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">rank_insertions_trios</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
            <span class="p">)</span>
            <span class="n">coord_system_tag_attrib_insertion_trios</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="p">(</span><span class="n">seq_region_id</span><span class="p">,</span> <span class="n">coord_system_tag_attrib_id</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">quote_or_null</span><span class="p">(</span><span class="n">coord_system_tag</span><span class="p">))</span>
            <span class="p">)</span>

            <span class="c1"># filling update list for &quot;coord_system_tag&quot; with seq_region_ids</span>
            <span class="n">coord_system_tag_attrib_seq_region_update_ids</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">seq_region_id</span><span class="p">)</span>

        <span class="c1"># run insertion SQL for &quot;karyotype_rank&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">insert_to_db</span><span class="p">(</span>
            <span class="n">rank_insertions_trios</span><span class="p">,</span>
            <span class="s2">&quot;seq_region_attrib&quot;</span><span class="p">,</span>
            <span class="p">[</span><span class="s2">&quot;seq_region_id&quot;</span><span class="p">,</span> <span class="s2">&quot;attrib_type_id&quot;</span><span class="p">,</span> <span class="s2">&quot;value&quot;</span><span class="p">],</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pjc</span><span class="p">(</span><span class="n">work_dir</span><span class="p">,</span> <span class="s2">&quot;karyotype_rank_insertion&quot;</span><span class="p">),</span>
            <span class="n">ignore</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="c1"># run insertion SQL for &quot;coord_system_tag&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">insert_to_db</span><span class="p">(</span>
            <span class="n">coord_system_tag_attrib_insertion_trios</span><span class="p">,</span>
            <span class="s2">&quot;seq_region_attrib&quot;</span><span class="p">,</span>
            <span class="p">[</span><span class="s2">&quot;seq_region_id&quot;</span><span class="p">,</span> <span class="s2">&quot;attrib_type_id&quot;</span><span class="p">,</span> <span class="s2">&quot;value&quot;</span><span class="p">],</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pjc</span><span class="p">(</span><span class="n">work_dir</span><span class="p">,</span> <span class="s2">&quot;coord_system_tag_insertion&quot;</span><span class="p">),</span>
            <span class="n">ignore</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="c1"># forcing update of the &quot;coord_system_tag&quot;</span>
        <span class="k">if</span> <span class="n">force_update_coord_system_tag</span> <span class="ow">and</span> <span class="n">coord_system_tag_attrib_seq_region_update_ids</span><span class="p">:</span>
            <span class="n">seq_region_ids_str</span> <span class="o">=</span> <span class="s2">&quot;,&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">coord_system_tag_attrib_seq_region_update_ids</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">update_db_single_group</span><span class="p">(</span>
                <span class="p">{</span><span class="s2">&quot;value&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">quote_or_null</span><span class="p">(</span><span class="n">coord_system_tag</span><span class="p">)},</span>
                <span class="s2">&quot;seq_region_attrib&quot;</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">pjc</span><span class="p">(</span><span class="n">work_dir</span><span class="p">,</span> <span class="s2">&quot;coord_system_tag_update&quot;</span><span class="p">),</span>
                <span class="n">where</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;attrib_type_id = </span><span class="si">{</span><span class="n">coord_system_tag_attrib_id</span><span class="si">}</span><span class="s2"> and seq_region_id in (</span><span class="si">{</span><span class="n">seq_region_ids_str</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="c1"># return resulting list of regions with bands trios</span>
        <span class="k">return</span> <span class="n">regions_with_ranks_from_assembly_metadata</span></div>

<div class="viewcode-block" id="load_sequence_data.add_karyotype_rank_for_chromosomes"><a class="viewcode-back" href="../../../../ensembl.brc4.runnable.html#ensembl.brc4.runnable.load_sequence_data.load_sequence_data.add_karyotype_rank_for_chromosomes">[docs]</a>    <span class="k">def</span> <span class="nf">add_karyotype_rank_for_chromosomes</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">attrib_type_map</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">work_dir</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">chromosome_coord_system_name</span><span class="o">=</span><span class="s2">&quot;chromosome&quot;</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">:</span>  <span class="c1"># [ (seq_region_name, seq_region_id, unversioned_name) ]</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Add `karyotype_rank` attributes for seq region data from the &quot;chromosome&quot; coordinate system.</span>

<span class="sd">        Returns list of [ (seq_region_name, seq_region_id, unversioned_name) ] trios for seq_regions with updated karyotype_ranks.</span>
<span class="sd">        Not altering &quot;coord_system_tag&quot; tag attributes.</span>

<span class="sd">        If unversion is true:</span>
<span class="sd">          * the unversioned synonym would be used to get the seq_region_id from &quot;seq_region_map&quot; if possible</span>

<span class="sd">        Too close to the DB schema.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># resulting list of seq_region with karyotype_rank</span>
        <span class="c1">#   list of top level seq regions from the `chromosome_coord_system_name`</span>
        <span class="n">chromomes_seq_regions</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_toplevel_from_cs</span><span class="p">(</span>
            <span class="n">chromosome_coord_system_name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">pjc</span><span class="p">(</span><span class="n">work_dir</span><span class="p">,</span> <span class="s2">&quot;chromosome_seq_regions&quot;</span><span class="p">)</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">chromomes_seq_regions</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">chromomes_seq_regions</span>

        <span class="c1"># technical / optimization. get external_db_id for &quot;karyotype_rank&quot;</span>
        <span class="n">karyotype_rank_attrib_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">id_from_map_or_die</span><span class="p">(</span>
            <span class="s2">&quot;karyotype_rank&quot;</span><span class="p">,</span> <span class="n">attrib_type_map</span><span class="p">,</span> <span class="s2">&quot;attrib_type_map&quot;</span>
        <span class="p">)</span>

        <span class="c1"># set/update proper attributes for &quot;chromomosome&quot; regions</span>
        <span class="n">rank_insertions_trios</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">seq_region_id</span><span class="p">,</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">chromomes_seq_regions</span><span class="p">:</span>
            <span class="n">rank_insertions_trios</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="p">(</span><span class="n">seq_region_id</span><span class="p">,</span> <span class="n">karyotype_rank_attrib_id</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">rank_insertions_trios</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
            <span class="p">)</span>

        <span class="c1"># run insertion SQL for &quot;karyotype_rank&quot;</span>
        <span class="c1">#    do not alter &quot;coord_system_tag&quot; anyhow in the case of the &quot;chromosome&quot; coord_system</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">insert_to_db</span><span class="p">(</span>
            <span class="n">rank_insertions_trios</span><span class="p">,</span>
            <span class="s2">&quot;seq_region_attrib&quot;</span><span class="p">,</span>
            <span class="p">[</span><span class="s2">&quot;seq_region_id&quot;</span><span class="p">,</span> <span class="s2">&quot;attrib_type_id&quot;</span><span class="p">,</span> <span class="s2">&quot;value&quot;</span><span class="p">],</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pjc</span><span class="p">(</span><span class="n">work_dir</span><span class="p">,</span> <span class="s2">&quot;karyotype_rank_insertion&quot;</span><span class="p">),</span>
            <span class="n">ignore</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="k">return</span> <span class="n">chromomes_seq_regions</span></div>

<div class="viewcode-block" id="load_sequence_data.add_karyotype_rank_from_bands_info"><a class="viewcode-back" href="../../../../ensembl.brc4.runnable.html#ensembl.brc4.runnable.load_sequence_data.load_sequence_data.add_karyotype_rank_from_bands_info">[docs]</a>    <span class="k">def</span> <span class="nf">add_karyotype_rank_from_bands_info</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">regions_with_karyotype_bands</span><span class="p">:</span> <span class="nb">list</span><span class="p">,</span>  <span class="c1"># [ (seq_region_name, seq_region_id, unversioned_name) ]</span>
        <span class="n">other_regions_with_ranks</span><span class="p">:</span> <span class="nb">list</span><span class="p">,</span>  <span class="c1"># [ (seq_region_name, seq_region_id, unversioned_name) ]</span>
        <span class="n">attrib_type_map</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span>
        <span class="n">work_dir</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Add karyotype_ranks for `regions_with_karyotype_bands` (those with karyotype bands in seq_region metadata) but not present in `other_regions_with_ranks` list.</span>

<span class="sd">        Too close to the DB schema.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># form set of used seq_region_id(s)</span>
        <span class="n">regions_with_ranks</span> <span class="o">=</span> <span class="nb">frozenset</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">el</span><span class="p">:</span> <span class="n">el</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">other_regions_with_ranks</span><span class="p">))</span>

        <span class="c1"># get set of seq_region_ids with bands</span>
        <span class="n">regions_with_bands</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">el</span><span class="p">:</span> <span class="n">el</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">regions_with_karyotype_bands</span><span class="p">))</span>

        <span class="c1"># seq_region_ids list to add ranks for</span>
        <span class="n">region_ids_with_bands_but_no_karyotype_ranks</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">regions_with_bands</span> <span class="o">-</span> <span class="n">regions_with_ranks</span><span class="p">))</span>

        <span class="c1"># return if nothing to add</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">region_ids_with_bands_but_no_karyotype_ranks</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="c1"># technical / optimization. get external_db_id for &quot;karyotype_rank&quot;</span>
        <span class="n">karyotype_rank_attrib_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">id_from_map_or_die</span><span class="p">(</span>
            <span class="s2">&quot;karyotype_rank&quot;</span><span class="p">,</span> <span class="n">attrib_type_map</span><span class="p">,</span> <span class="s2">&quot;attrib_type_map&quot;</span>
        <span class="p">)</span>

        <span class="c1"># set/update proper attributes for &quot;chromomosome&quot; regions</span>
        <span class="n">rank_insertions_trios</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">seq_region_id</span> <span class="ow">in</span> <span class="n">region_ids_with_bands_but_no_karyotype_ranks</span><span class="p">:</span>
            <span class="n">rank_insertions_trios</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="p">(</span>
                    <span class="n">seq_region_id</span><span class="p">,</span>
                    <span class="n">karyotype_rank_attrib_id</span><span class="p">,</span>
                    <span class="nb">len</span><span class="p">(</span><span class="n">rank_insertions_trios</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">regions_with_ranks</span><span class="p">),</span>
                <span class="p">)</span>
            <span class="p">)</span>

        <span class="c1"># run insertion SQL for &quot;karyotype_rank&quot;</span>
        <span class="c1">#    do not alter &quot;coord_system_tag&quot; anyhow in the case of the &quot;chromosome&quot; coord_system</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">insert_to_db</span><span class="p">(</span>
            <span class="n">rank_insertions_trios</span><span class="p">,</span>
            <span class="s2">&quot;seq_region_attrib&quot;</span><span class="p">,</span>
            <span class="p">[</span><span class="s2">&quot;seq_region_id&quot;</span><span class="p">,</span> <span class="s2">&quot;attrib_type_id&quot;</span><span class="p">,</span> <span class="s2">&quot;value&quot;</span><span class="p">],</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pjc</span><span class="p">(</span><span class="n">work_dir</span><span class="p">,</span> <span class="s2">&quot;karyotype_rank_insertion&quot;</span><span class="p">),</span>
            <span class="n">ignore</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="p">)</span></div>

<div class="viewcode-block" id="load_sequence_data.unversion_scaffolds"><a class="viewcode-back" href="../../../../ensembl.brc4.runnable.html#ensembl.brc4.runnable.load_sequence_data.load_sequence_data.unversion_scaffolds">[docs]</a>    <span class="k">def</span> <span class="nf">unversion_scaffolds</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cs_rank</span><span class="p">,</span> <span class="n">logs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Unversion scaffold, remove &quot;.\d$&quot; from seq_region.names if there&#39;s a need</span>

<span class="sd">        Non-versioned syns for contigs (lower, sequence level), versioned for the rest.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">seq_cs</span><span class="p">,</span> <span class="n">max_rank</span> <span class="o">=</span> <span class="nb">max</span><span class="p">([(</span><span class="n">c</span><span class="p">,</span> <span class="n">r</span><span class="p">)</span> <span class="k">for</span> <span class="n">c</span><span class="p">,</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">cs_rank</span><span class="o">.</span><span class="n">items</span><span class="p">()],</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">k</span><span class="p">:</span> <span class="n">k</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="k">for</span> <span class="n">cs</span> <span class="ow">in</span> <span class="n">cs_rank</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">cs</span> <span class="o">==</span> <span class="n">seq_cs</span><span class="p">:</span>
                <span class="c1"># for non-sequence level cs, store original name (with version) as &quot;sr_syn_src&quot; synonym</span>
                <span class="n">xdb</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">param</span><span class="p">(</span><span class="s2">&quot;sr_syn_src&quot;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">copy_sr_name_to_syn</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="n">xdb</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">pjc</span><span class="p">(</span><span class="n">logs</span><span class="p">,</span> <span class="s2">&quot;cp2syn&quot;</span><span class="p">,</span> <span class="n">cs</span><span class="p">))</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">sr_name_unversion</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="s2">&quot;seq_region_synonym&quot;</span><span class="p">,</span> <span class="s2">&quot;synonym&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">pjc</span><span class="p">(</span><span class="n">logs</span><span class="p">,</span> <span class="s2">&quot;unv_srs&quot;</span><span class="p">,</span> <span class="n">cs</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># for sequence-level cs, store original name (with version) as &quot;versioned_sr_syn_src&quot; synonym</span>
                <span class="n">xdb</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">param</span><span class="p">(</span><span class="s2">&quot;versioned_sr_syn_src&quot;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">copy_sr_name_to_syn</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="n">xdb</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">pjc</span><span class="p">(</span><span class="n">logs</span><span class="p">,</span> <span class="s2">&quot;cp2syn&quot;</span><span class="p">,</span> <span class="n">cs</span><span class="p">))</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">sr_name_unversion</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="s2">&quot;seq_region&quot;</span><span class="p">,</span> <span class="s2">&quot;name&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">pjc</span><span class="p">(</span><span class="n">logs</span><span class="p">,</span> <span class="s2">&quot;unv_sr&quot;</span><span class="p">,</span> <span class="n">cs</span><span class="p">))</span></div>

<div class="viewcode-block" id="load_sequence_data.coord_sys_order"><a class="viewcode-back" href="../../../../ensembl.brc4.runnable.html#ensembl.brc4.runnable.load_sequence_data.load_sequence_data.coord_sys_order">[docs]</a>    <span class="k">def</span> <span class="nf">coord_sys_order</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cs_order_str</span><span class="p">):</span>
        <span class="n">cs_order_lst</span> <span class="o">=</span> <span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">strip</span><span class="p">(),</span> <span class="n">cs_order_str</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">))</span>
        <span class="k">return</span> <span class="p">{</span><span class="n">e</span><span class="p">:</span> <span class="n">i</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">e</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">filter</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span> <span class="n">cs_order_lst</span><span class="p">))}</span></div>

<div class="viewcode-block" id="load_sequence_data.used_cs_ranks"><a class="viewcode-back" href="../../../../ensembl.brc4.runnable.html#ensembl.brc4.runnable.load_sequence_data.load_sequence_data.used_cs_ranks">[docs]</a>    <span class="k">def</span> <span class="nf">used_cs_ranks</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">agps</span><span class="p">,</span> <span class="n">cs_order</span><span class="p">,</span> <span class="n">noagp_default</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="c1"># rank cs_names, met in agps.keys (&quot;-&quot; separated), i.e. &quot;scaffold-contig&quot;</span>
        <span class="c1">#   only agps keys used, values are ignored</span>
        <span class="c1">#   use noagp_cs_name_default for &quot;noagp&quot; assemblies</span>
        <span class="k">if</span> <span class="n">agps</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">noagp_default</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;NoAGP assembly with no default coordinate system name&quot;</span><span class="p">)</span>
            <span class="n">cs_used_set</span> <span class="o">=</span> <span class="nb">frozenset</span><span class="p">([</span><span class="n">noagp_default</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">cs_used_set</span> <span class="o">=</span> <span class="nb">frozenset</span><span class="p">(</span><span class="nb">sum</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;-&quot;</span><span class="p">),</span> <span class="n">agps</span><span class="o">.</span><span class="n">keys</span><span class="p">()),</span> <span class="p">[]))</span>

        <span class="n">cs_unknown</span> <span class="o">=</span> <span class="n">cs_used_set</span><span class="o">.</span><span class="n">difference</span><span class="p">(</span><span class="n">cs_order</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">cs_unknown</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Unknown coordinate system(s) </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">{</span><span class="nb">str</span><span class="p">(</span><span class="n">cs_unknown</span><span class="p">)})</span>
        <span class="k">return</span> <span class="p">{</span><span class="n">e</span><span class="p">:</span> <span class="n">i</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">e</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">cs_used_set</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="o">-</span><span class="n">cs_order</span><span class="p">[</span><span class="n">x</span><span class="p">]),</span> <span class="n">start</span><span class="o">=</span><span class="mi">1</span><span class="p">)}</span></div>

<div class="viewcode-block" id="load_sequence_data.chunk_contigs"><a class="viewcode-back" href="../../../../ensembl.brc4.runnable.html#ensembl.brc4.runnable.load_sequence_data.load_sequence_data.chunk_contigs">[docs]</a>    <span class="k">def</span> <span class="nf">chunk_contigs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fasta</span><span class="p">,</span> <span class="n">cs_ranks</span><span class="p">,</span> <span class="n">agps</span><span class="p">,</span> <span class="n">work_dir</span><span class="p">,</span> <span class="n">chunk_size</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">chunks_cs_name</span><span class="o">=</span><span class="s2">&quot;ensembl_internal&quot;</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        chunk dna sequence fasta</span>
<span class="sd">          no chunking if chunk_size &lt; 50k</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">chunk_size_min_len</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">param_required</span><span class="p">(</span><span class="s2">&quot;sequence_data_chunck_min_len&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">chunk_size</span> <span class="o">&lt;</span> <span class="n">chunk_size_min_len</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">fasta</span><span class="p">,</span> <span class="n">cs_ranks</span><span class="p">,</span> <span class="n">agps</span>

        <span class="c1"># split using script</span>
        <span class="n">en_root</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">param_required</span><span class="p">(</span><span class="s2">&quot;ensembl_root_dir&quot;</span><span class="p">)</span>
        <span class="n">_splitter</span> <span class="o">=</span> <span class="n">pj</span><span class="p">(</span><span class="n">en_root</span><span class="p">,</span> <span class="sa">r</span><span class="s2">&quot;ensembl-genomio/scripts/chunk_fasta.py&quot;</span><span class="p">)</span>

        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">work_dir</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="n">_stderr</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">work_dir</span><span class="si">}</span><span class="s2">/chunking.stderr&quot;</span>
        <span class="n">_out_agp</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">work_dir</span><span class="si">}</span><span class="s2">/chunks.agp&quot;</span>
        <span class="n">_out_fasta</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">work_dir</span><span class="si">}</span><span class="s2">/chunks.fasta&quot;</span>
        <span class="n">split_cmd</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;python </span><span class="si">{</span><span class="n">_splitter</span><span class="si">}</span><span class="s2"> --chunk_size </span><span class="si">{</span><span class="n">chunk_size</span><span class="si">}</span><span class="s2"> --agp_out </span><span class="si">{</span><span class="n">_out_agp</span><span class="si">}</span><span class="s2"> --out </span><span class="si">{</span><span class="n">_out_fasta</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">fasta</span><span class="si">}</span><span class="s2"> 2&gt; </span><span class="si">{</span><span class="n">_stderr</span><span class="si">}</span><span class="s2">&quot;</span>

        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;running </span><span class="si">{</span><span class="n">split_cmd</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">)</span>
        <span class="c1"># NB throws CalledProcessError if failed</span>
        <span class="n">sp</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">split_cmd</span><span class="p">,</span> <span class="n">shell</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">check</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="c1"># add rank for chunks</span>
        <span class="n">_cs_name</span><span class="p">,</span> <span class="n">_cs_rank</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">cs_ranks</span><span class="o">.</span><span class="n">items</span><span class="p">(),</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">k</span><span class="p">:</span> <span class="n">k</span><span class="p">[</span><span class="mi">1</span><span class="p">])[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">cs_ranks</span><span class="p">[</span><span class="n">chunks_cs_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">_cs_rank</span> <span class="o">+</span> <span class="mi">1</span>

        <span class="c1"># add agps entry</span>
        <span class="k">if</span> <span class="n">agps</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">agps</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="n">agps</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">_cs_name</span><span class="si">}</span><span class="s2">-</span><span class="si">{</span><span class="n">chunks_cs_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">_out_agp</span>

        <span class="k">return</span> <span class="n">_out_fasta</span><span class="p">,</span> <span class="n">cs_ranks</span><span class="p">,</span> <span class="n">agps</span></div>

<div class="viewcode-block" id="load_sequence_data.prune_agps"><a class="viewcode-back" href="../../../../ensembl.brc4.runnable.html#ensembl.brc4.runnable.load_sequence_data.load_sequence_data.prune_agps">[docs]</a>    <span class="k">def</span> <span class="nf">prune_agps</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">agps</span><span class="p">,</span> <span class="n">cs_order</span><span class="p">,</span> <span class="n">agps_pruned_dir</span><span class="p">,</span> <span class="n">pruning</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="c1"># when loading agp sort by:</span>
        <span class="c1">#   highest component (cmp) cs level (lowest rank)</span>
        <span class="c1">#   lowest difference between cs ranks (asm - cmp)</span>
        <span class="c1">#   i.e: chromosome-scaffold scaffold-chunk chromosome-chunk</span>
        <span class="c1">#   if no agps return empty pruned result</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">agps</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="n">agp_levels_sorted</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">order_agp_levels</span><span class="p">(</span><span class="n">agps</span><span class="p">,</span> <span class="n">cs_order</span><span class="p">)</span>

        <span class="c1"># prune agps</span>
        <span class="n">agps_pruned</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="n">used_components</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">pruning</span><span class="p">:</span>
            <span class="n">used_components</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">for</span> <span class="n">asm_cmp</span> <span class="ow">in</span> <span class="n">agp_levels_sorted</span><span class="p">:</span>
            <span class="n">agp_file_src</span> <span class="o">=</span> <span class="n">agps</span><span class="p">[</span><span class="n">asm_cmp</span><span class="p">]</span>
            <span class="n">agp_file_dst</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pjc</span><span class="p">(</span><span class="n">agps_pruned_dir</span><span class="p">,</span> <span class="n">asm_cmp</span> <span class="o">+</span> <span class="s2">&quot;.agp&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">agp_prune</span><span class="p">(</span><span class="n">agp_file_src</span><span class="p">,</span> <span class="n">agp_file_dst</span><span class="p">,</span> <span class="n">used_components</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">agps_pruned</span><span class="p">[</span><span class="n">asm_cmp</span><span class="p">]</span> <span class="o">=</span> <span class="n">agp_file_dst</span>
        <span class="k">return</span> <span class="n">agps_pruned</span></div>

<div class="viewcode-block" id="load_sequence_data.order_agp_levels"><a class="viewcode-back" href="../../../../ensembl.brc4.runnable.html#ensembl.brc4.runnable.load_sequence_data.load_sequence_data.order_agp_levels">[docs]</a>    <span class="k">def</span> <span class="nf">order_agp_levels</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">agps</span><span class="p">,</span> <span class="n">cs_order</span><span class="p">):</span>
        <span class="c1"># sort agp for loading by:</span>
        <span class="c1">#   highest component (cmp) cs level (lowest rank)</span>
        <span class="c1">#   lowest difference between cs ranks (asm - cmp)</span>
        <span class="c1">#   i.e: chromosome-scaffold scaffold-chunk chromosome-chunk</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">agps</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">[]</span>

        <span class="n">agp_cs_pairs</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="o">+</span> <span class="n">x</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;-&quot;</span><span class="p">),</span> <span class="n">agps</span><span class="o">.</span><span class="n">keys</span><span class="p">()))</span>
        <span class="n">agp_levels</span> <span class="o">=</span> <span class="p">[(</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">cs_order</span><span class="p">[</span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">]],</span> <span class="n">cs_order</span><span class="p">[</span><span class="n">x</span><span class="p">[</span><span class="mi">2</span><span class="p">]])</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">agp_cs_pairs</span><span class="p">]</span>

        <span class="n">bad_agps</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">filter</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">x</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">agp_levels</span><span class="p">))</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">bad_agps</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;component cs has higher order than assembled cs </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">bad_agps</span><span class="p">)))</span>

        <span class="n">agp_levels_sorted</span> <span class="o">=</span> <span class="p">[</span><span class="n">e</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">agp_levels</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="p">(</span><span class="o">-</span><span class="n">x</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">x</span><span class="p">[</span><span class="mi">2</span><span class="p">]))]</span>
        <span class="k">return</span> <span class="n">agp_levels_sorted</span></div>

<div class="viewcode-block" id="load_sequence_data.load_seq_data"><a class="viewcode-back" href="../../../../ensembl.brc4.runnable.html#ensembl.brc4.runnable.load_sequence_data.load_sequence_data.load_seq_data">[docs]</a>    <span class="k">def</span> <span class="nf">load_seq_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fasta</span><span class="p">,</span> <span class="n">agps</span><span class="p">,</span> <span class="n">cs_rank</span><span class="p">,</span> <span class="n">log_pfx</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;loads sequence data for various coordinate systems accordingly with their rank&quot;&quot;&quot;</span>
        <span class="n">asm_v</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">asm_name</span><span class="p">()</span>

        <span class="n">sequence_rank</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">cs_rank</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
        <span class="k">for</span> <span class="n">cs</span><span class="p">,</span> <span class="n">rank</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">cs_rank</span><span class="o">.</span><span class="n">items</span><span class="p">(),</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">p</span><span class="p">:</span> <span class="o">-</span><span class="n">p</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
            <span class="n">logs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pjc</span><span class="p">(</span><span class="n">log_pfx</span><span class="p">,</span> <span class="s2">&quot;</span><span class="si">%02d</span><span class="s2">_</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">rank</span><span class="p">,</span> <span class="n">cs</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">rank</span> <span class="o">==</span> <span class="n">sequence_rank</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">load_cs_data</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="n">rank</span><span class="p">,</span> <span class="s2">&quot;fasta&quot;</span><span class="p">,</span> <span class="n">asm_v</span><span class="p">,</span> <span class="n">fasta</span><span class="p">,</span> <span class="n">logs</span><span class="p">,</span> <span class="n">loaded_regions</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">seq_level</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">useful_agps</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">filter</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">cs</span> <span class="ow">in</span> <span class="n">x</span><span class="p">,</span> <span class="n">agps</span> <span class="ow">and</span> <span class="n">agps</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="ow">or</span> <span class="p">[]))</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">useful_agps</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;non-seq_level cs </span><span class="si">%s</span><span class="s2"> has no agps to assemble it from&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">cs</span><span class="p">))</span>
                <span class="n">loaded_regions</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
                <span class="k">for</span> <span class="n">pair</span><span class="p">,</span> <span class="n">agp_file_pruned</span> <span class="ow">in</span> <span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">k</span><span class="p">:</span> <span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">agps</span><span class="p">[</span><span class="n">k</span><span class="p">]),</span> <span class="n">useful_agps</span><span class="p">):</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">pair</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">cs</span> <span class="o">+</span> <span class="s2">&quot;-&quot;</span><span class="p">):</span>
                        <span class="k">continue</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">load_cs_data</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="n">rank</span><span class="p">,</span> <span class="n">pair</span><span class="p">,</span> <span class="n">asm_v</span><span class="p">,</span> <span class="n">agp_file_pruned</span><span class="p">,</span> <span class="n">logs</span><span class="p">,</span> <span class="n">loaded_regions</span><span class="p">)</span></div>

<div class="viewcode-block" id="load_sequence_data.load_cs_data"><a class="viewcode-back" href="../../../../ensembl.brc4.runnable.html#ensembl.brc4.runnable.load_sequence_data.load_sequence_data.load_cs_data">[docs]</a>    <span class="k">def</span> <span class="nf">load_cs_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cs</span><span class="p">,</span> <span class="n">rank</span><span class="p">,</span> <span class="n">pair</span><span class="p">,</span> <span class="n">asm_v</span><span class="p">,</span> <span class="n">src_file</span><span class="p">,</span> <span class="n">log_pfx</span><span class="p">,</span> <span class="n">loaded_regions</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">seq_level</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;creates a coord_system and loads sequence or assembly(AGP) data for corresponding seqregions</span>

<span class="sd">        doesn&#39;t load already seen sequences</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># NB load_seq_region.pl and load_agp.pl are not failing on parameter errors (0 exit code)</span>
        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">dirname</span><span class="p">(</span><span class="n">log_pfx</span><span class="p">),</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">additional_load</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">param_bool</span><span class="p">(</span><span class="s2">&quot;load_additional_sequences&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">seq_level</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">load_seq_region</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="n">rank</span><span class="p">,</span> <span class="n">asm_v</span><span class="p">,</span> <span class="n">src_file</span><span class="p">,</span> <span class="n">log_pfx</span><span class="p">,</span> <span class="n">seq_level</span><span class="p">,</span> <span class="n">additional_load</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">loaded_regions</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">new_regions</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
            <span class="n">clean_file</span> <span class="o">=</span> <span class="n">src_file</span> <span class="o">+</span> <span class="s2">&quot;.regions_deduped&quot;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">filter_already_loaded_regions_from_agp</span><span class="p">(</span><span class="n">src_file</span><span class="p">,</span> <span class="n">clean_file</span><span class="p">,</span> <span class="n">loaded_regions</span><span class="p">,</span> <span class="n">new_regions</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">load_seq_region</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="n">rank</span><span class="p">,</span> <span class="n">asm_v</span><span class="p">,</span> <span class="n">clean_file</span><span class="p">,</span> <span class="n">log_pfx</span><span class="p">,</span> <span class="n">seq_level</span><span class="p">,</span> <span class="n">additional_load</span><span class="p">)</span>
            <span class="n">loaded_regions</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">new_regions</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">seq_level</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">load_agp</span><span class="p">(</span><span class="n">pair</span><span class="p">,</span> <span class="n">asm_v</span><span class="p">,</span> <span class="n">src_file</span><span class="p">,</span> <span class="n">log_pfx</span><span class="p">)</span></div>

<div class="viewcode-block" id="load_sequence_data.filter_already_loaded_regions_from_agp"><a class="viewcode-back" href="../../../../ensembl.brc4.runnable.html#ensembl.brc4.runnable.load_sequence_data.load_sequence_data.filter_already_loaded_regions_from_agp">[docs]</a>    <span class="k">def</span> <span class="nf">filter_already_loaded_regions_from_agp</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">src_file</span><span class="p">,</span> <span class="n">dst_file</span><span class="p">,</span> <span class="n">loaded_regions</span><span class="p">,</span> <span class="n">new_regions</span><span class="p">):</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">src_file</span><span class="p">)</span> <span class="k">as</span> <span class="n">src</span><span class="p">:</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">dst_file</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">dst</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">src</span><span class="p">:</span>
                    <span class="n">fields</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="p">(</span>
                        <span class="n">asm_id</span><span class="p">,</span>
                        <span class="n">asm_start</span><span class="p">,</span>
                        <span class="n">asm_end</span><span class="p">,</span>
                        <span class="n">asm_part</span><span class="p">,</span>
                        <span class="n">type_</span><span class="p">,</span>
                        <span class="n">cmp_id</span><span class="p">,</span>
                        <span class="n">cmp_start</span><span class="p">,</span>
                        <span class="n">cmp_end</span><span class="p">,</span>
                        <span class="n">cmp_strand</span><span class="p">,</span>
                    <span class="p">)</span> <span class="o">=</span> <span class="n">fields</span>
                    <span class="k">if</span> <span class="n">type_</span> <span class="ow">in</span> <span class="s2">&quot;NU&quot;</span> <span class="ow">or</span> <span class="n">asm_id</span> <span class="ow">in</span> <span class="n">loaded_regions</span><span class="p">:</span>
                        <span class="k">continue</span>
                    <span class="n">new_regions</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">asm_id</span><span class="p">)</span>
                    <span class="nb">print</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">(),</span> <span class="n">file</span><span class="o">=</span><span class="n">dst</span><span class="p">)</span></div>

<div class="viewcode-block" id="load_sequence_data.agp_prune"><a class="viewcode-back" href="../../../../ensembl.brc4.runnable.html#ensembl.brc4.runnable.load_sequence_data.load_sequence_data.agp_prune">[docs]</a>    <span class="k">def</span> <span class="nf">agp_prune</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">from_file</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">to_file</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">used</span><span class="p">:</span> <span class="nb">set</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Remove already components from the AGP file if they are seen in &quot;used&quot; set</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># reomve used component</span>
        <span class="c1">#   and GAPS as they are not used by &#39;ensembl-analysis/scripts/assembly_loading/load_agp.pl&#39;</span>
        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">dirname</span><span class="p">(</span><span class="n">to_file</span><span class="p">),</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">open_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_gz</span><span class="p">(</span><span class="n">from_file</span><span class="p">)</span> <span class="ow">and</span> <span class="n">gzip</span><span class="o">.</span><span class="n">open</span> <span class="ow">or</span> <span class="nb">open</span>
        <span class="k">if</span> <span class="n">used</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">cmd</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;&quot;&quot;</span><span class="si">{_cat}</span><span class="s2"> </span><span class="si">{_file}</span><span class="s2"> &gt; </span><span class="si">{_out}</span><span class="s2">&quot;&quot;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">_cat</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">is_gz</span><span class="p">(</span><span class="n">from_file</span><span class="p">)</span> <span class="ow">and</span> <span class="s2">&quot;zcat&quot;</span> <span class="ow">or</span> <span class="s2">&quot;cat&quot;</span><span class="p">,</span> <span class="n">_file</span><span class="o">=</span><span class="n">from_file</span><span class="p">,</span> <span class="n">_out</span><span class="o">=</span><span class="n">to_file</span>
            <span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;running </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">cmd</span><span class="p">),</span> <span class="n">file</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">)</span>
            <span class="n">sp</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">shell</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">check</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">return</span> <span class="mi">1</span>
        <span class="n">writes</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">with</span> <span class="n">open_</span><span class="p">(</span><span class="n">from_file</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">src</span><span class="p">:</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">to_file</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">dst</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">src</span><span class="p">:</span>
                    <span class="n">fields</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="p">(</span>
                        <span class="n">asm_id</span><span class="p">,</span>
                        <span class="n">asm_start</span><span class="p">,</span>
                        <span class="n">asm_end</span><span class="p">,</span>
                        <span class="n">asm_part</span><span class="p">,</span>
                        <span class="n">type_</span><span class="p">,</span>
                        <span class="n">cmp_id</span><span class="p">,</span>
                        <span class="n">cmp_start</span><span class="p">,</span>
                        <span class="n">cmp_end</span><span class="p">,</span>
                        <span class="n">cmp_strand</span><span class="p">,</span>
                    <span class="p">)</span> <span class="o">=</span> <span class="n">fields</span>
                    <span class="k">if</span> <span class="n">type_</span> <span class="ow">in</span> <span class="s2">&quot;NU&quot;</span> <span class="ow">or</span> <span class="n">cmp_id</span> <span class="ow">in</span> <span class="n">used</span><span class="p">:</span>
                        <span class="k">continue</span>
                    <span class="n">used</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">cmp_id</span><span class="p">)</span>
                    <span class="nb">print</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">(),</span> <span class="n">file</span><span class="o">=</span><span class="n">dst</span><span class="p">)</span>
                    <span class="n">writes</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">return</span> <span class="n">writes</span></div>

<div class="viewcode-block" id="load_sequence_data.get_external_db_mapping"><a class="viewcode-back" href="../../../../ensembl.brc4.runnable.html#ensembl.brc4.runnable.load_sequence_data.load_sequence_data.get_external_db_mapping">[docs]</a>    <span class="k">def</span> <span class="nf">get_external_db_mapping</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get a map from a file for external_dbs to Ensembl dbnames from &quot;external_db_map&quot; module(!) param</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">external_map_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">param</span><span class="p">(</span><span class="s2">&quot;external_db_map&quot;</span><span class="p">)</span>
        <span class="n">db_map</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">external_map_path</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">db_map</span>

        <span class="c1"># Load the map</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">external_map_path</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">map_file</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">map_file</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;#&quot;</span><span class="p">):</span>
                    <span class="k">continue</span>
                <span class="n">line</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;#.*&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">line</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;^\s*$&quot;</span><span class="p">,</span> <span class="n">line</span><span class="p">):</span>
                    <span class="k">continue</span>
                <span class="p">(</span><span class="n">from_name</span><span class="p">,</span> <span class="n">to_name</span><span class="p">,</span> <span class="o">*</span><span class="n">rest</span><span class="p">)</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">rest</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">rest</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="o">!=</span> <span class="s2">&quot;SEQ_REGION&quot;</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="k">if</span> <span class="n">to_name</span> <span class="o">==</span> <span class="s2">&quot;_IGNORE_&quot;</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="n">db_map</span><span class="p">[</span><span class="n">from_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">to_name</span>
        <span class="k">return</span> <span class="n">db_map</span></div>

    <span class="c1"># UTILS</span>
<div class="viewcode-block" id="load_sequence_data.db_string"><a class="viewcode-back" href="../../../../ensembl.brc4.runnable.html#ensembl.brc4.runnable.load_sequence_data.load_sequence_data.db_string">[docs]</a>    <span class="k">def</span> <span class="nf">db_string</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s2">&quot;-dbhost </span><span class="si">{host_}</span><span class="s2"> -dbport </span><span class="si">{port_}</span><span class="s2"> -dbuser </span><span class="si">{user_}</span><span class="s2"> -dbpass </span><span class="si">{pass_}</span><span class="s2"> -dbname </span><span class="si">{dbname_}</span><span class="s2"> &quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="n">host_</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">param</span><span class="p">(</span><span class="s2">&quot;dbsrv_host&quot;</span><span class="p">),</span>
            <span class="n">port_</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">param</span><span class="p">(</span><span class="s2">&quot;dbsrv_port&quot;</span><span class="p">),</span>
            <span class="n">user_</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">param</span><span class="p">(</span><span class="s2">&quot;dbsrv_user&quot;</span><span class="p">),</span>
            <span class="n">pass_</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">param</span><span class="p">(</span><span class="s2">&quot;dbsrv_pass&quot;</span><span class="p">),</span>
            <span class="n">dbname_</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">param</span><span class="p">(</span><span class="s2">&quot;db_name&quot;</span><span class="p">),</span>
        <span class="p">)</span></div>

<div class="viewcode-block" id="load_sequence_data.pjc"><a class="viewcode-back" href="../../../../ensembl.brc4.runnable.html#ensembl.brc4.runnable.load_sequence_data.load_sequence_data.pjc">[docs]</a>    <span class="k">def</span> <span class="nf">pjc</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">parts</span><span class="p">:</span> <span class="nb">list</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Join path parts and try to create every directory but the last one.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">parts</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="n">parts</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">parts</span><span class="p">)</span>
        <span class="n">last</span> <span class="o">=</span> <span class="n">parts</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
        <span class="n">prefix</span> <span class="o">=</span> <span class="n">pj</span><span class="p">(</span><span class="o">*</span><span class="n">parts</span><span class="p">)</span>

        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">prefix</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">pj</span><span class="p">(</span><span class="n">prefix</span><span class="p">,</span> <span class="n">last</span><span class="p">)</span></div>

<div class="viewcode-block" id="load_sequence_data.is_gz"><a class="viewcode-back" href="../../../../ensembl.brc4.runnable.html#ensembl.brc4.runnable.load_sequence_data.load_sequence_data.is_gz">[docs]</a>    <span class="k">def</span> <span class="nf">is_gz</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">filename</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;.gz&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="load_sequence_data.asm_name"><a class="viewcode-back" href="../../../../ensembl.brc4.runnable.html#ensembl.brc4.runnable.load_sequence_data.load_sequence_data.asm_name">[docs]</a>    <span class="k">def</span> <span class="nf">asm_name</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">asm</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">from_param</span><span class="p">(</span><span class="s2">&quot;genome_data&quot;</span><span class="p">,</span> <span class="s2">&quot;assembly&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="s2">&quot;name&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">asm</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;no assembly/name in genome_data&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">asm</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span></div>

    <span class="c1"># TODO: add some metafunc setter getter</span>
<div class="viewcode-block" id="load_sequence_data.from_param"><a class="viewcode-back" href="../../../../ensembl.brc4.runnable.html#ensembl.brc4.runnable.load_sequence_data.load_sequence_data.from_param">[docs]</a>    <span class="k">def</span> <span class="nf">from_param</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">param</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">not_throw</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">param_required</span><span class="p">(</span><span class="n">param</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">not_throw</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">None</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Missing required </span><span class="si">%s</span><span class="s2"> data: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">param</span><span class="p">,</span> <span class="n">key</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">data</span><span class="p">[</span><span class="n">key</span><span class="p">]</span></div>

<div class="viewcode-block" id="load_sequence_data.param_bool"><a class="viewcode-back" href="../../../../ensembl.brc4.runnable.html#ensembl.brc4.runnable.load_sequence_data.load_sequence_data.param_bool">[docs]</a>    <span class="k">def</span> <span class="nf">param_bool</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">param</span><span class="p">):</span>
        <span class="n">val</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">param</span><span class="p">(</span><span class="n">param</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">bool</span><span class="p">(</span><span class="n">val</span><span class="p">)</span> <span class="ow">and</span> <span class="s2">&quot;0&quot;</span> <span class="o">!=</span> <span class="n">val</span></div>

<div class="viewcode-block" id="load_sequence_data.load_map_from_sql_stdout"><a class="viewcode-back" href="../../../../ensembl.brc4.runnable.html#ensembl.brc4.runnable.load_sequence_data.load_sequence_data.load_map_from_sql_stdout">[docs]</a>    <span class="k">def</span> <span class="nf">load_map_from_sql_stdout</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">in_file</span><span class="p">,</span> <span class="n">skip_header</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Load map from the SQL output</span>

<span class="sd">        Process input in_file with &quot;key  value&quot; pairs and load then</span>
<span class="sd">        into the {key : value} map.</span>
<span class="sd">        Skips header if skip_header.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">data</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">in_file</span><span class="p">)</span> <span class="k">as</span> <span class="n">pairs_file</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">pairs_file</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">skip_header</span><span class="p">:</span>
                    <span class="n">skip_header</span> <span class="o">=</span> <span class="kc">False</span>
                    <span class="k">continue</span>
                <span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">val</span><span class="p">)</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">data</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span>
        <span class="k">return</span> <span class="n">data</span></div>

<div class="viewcode-block" id="load_sequence_data.name_and_id_from_seq_region_item"><a class="viewcode-back" href="../../../../ensembl.brc4.runnable.html#ensembl.brc4.runnable.load_sequence_data.load_sequence_data.name_and_id_from_seq_region_item">[docs]</a>    <span class="k">def</span> <span class="nf">name_and_id_from_seq_region_item</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">seq_region_item</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span>
        <span class="n">seq_region_map</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span>
        <span class="n">try_unversion</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">throw_missing</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get (seq_region_name, seq_region_id, unversioned_name) from seq_region_item struct(dict)</span>

<span class="sd">        Gets unversioned_name only if &quot;try_unversion&quot; is True.</span>
<span class="sd">        Throws exception if not able to get seq_region_id from &quot;seq_region_map&quot; and &quot;throw_missing&quot; is true.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1">#   get seq_region_id (perhaps, by using unversioned name)</span>
        <span class="n">seq_region_name</span> <span class="o">=</span> <span class="n">seq_region_item</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span>
        <span class="n">seq_region_id</span> <span class="o">=</span> <span class="n">seq_region_map</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">seq_region_name</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="n">unversioned_name</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">seq_region_id</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">try_unversion</span><span class="p">:</span>
            <span class="c1"># try to get seq_region_id for the unversioned name</span>
            <span class="n">unversioned_name</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;\.\d+$&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">seq_region_name</span><span class="p">)</span>
            <span class="n">seq_region_id</span> <span class="o">=</span> <span class="n">seq_region_map</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">unversioned_name</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>

        <span class="c1"># oops, we don&#39;t know such seq_region name</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">seq_region_id</span> <span class="ow">and</span> <span class="n">throw_missing</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Not able to find seq_region for &#39;</span><span class="si">{</span><span class="n">seq_region_name</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="p">(</span><span class="n">seq_region_name</span><span class="p">,</span> <span class="n">seq_region_id</span><span class="p">,</span> <span class="n">unversioned_name</span><span class="p">)</span></div>

<div class="viewcode-block" id="load_sequence_data.id_from_map_or_die"><a class="viewcode-back" href="../../../../ensembl.brc4.runnable.html#ensembl.brc4.runnable.load_sequence_data.load_sequence_data.id_from_map_or_die">[docs]</a>    <span class="k">def</span> <span class="nf">id_from_map_or_die</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">map_dict</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">name_for_panic</span><span class="p">):</span>
        <span class="n">value</span> <span class="o">=</span> <span class="n">map_dict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;no such key &#39;</span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2">&#39; in &#39;</span><span class="si">{</span><span class="n">name_for_panic</span><span class="si">}</span><span class="s2">&#39; map&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">value</span></div>

    <span class="c1">## Utilities using external scripts</span>
<div class="viewcode-block" id="load_sequence_data.remove_IUPAC"><a class="viewcode-back" href="../../../../ensembl.brc4.runnable.html#ensembl.brc4.runnable.load_sequence_data.load_sequence_data.remove_IUPAC">[docs]</a>    <span class="k">def</span> <span class="nf">remove_IUPAC</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">from_file</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">to_file</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;remove non-valid symbols from FASTA file (using sed) ans store the result in a different location&quot;&quot;&quot;</span>
        <span class="n">IUPAC</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">param</span><span class="p">(</span><span class="s2">&quot;IUPAC&quot;</span><span class="p">)</span>
        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">dirname</span><span class="p">(</span><span class="n">to_file</span><span class="p">),</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">cmd</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;&quot;&quot;</span><span class="si">{_cat}</span><span class="s2"> </span><span class="si">{_file}</span><span class="s2"> | sed -r &#39;/^[^&gt;]/ {{ s/[</span><span class="si">{_IUPAC}</span><span class="s2">]/N/g; s/</span><span class="si">{_iupac}</span><span class="s2">/n/g }}&#39; &gt; </span><span class="si">{_out}</span><span class="s2">&quot;&quot;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="n">_cat</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">is_gz</span><span class="p">(</span><span class="n">from_file</span><span class="p">)</span> <span class="ow">and</span> <span class="s2">&quot;zcat&quot;</span> <span class="ow">or</span> <span class="s2">&quot;cat&quot;</span><span class="p">,</span>
            <span class="n">_file</span><span class="o">=</span><span class="n">from_file</span><span class="p">,</span>
            <span class="n">_IUPAC</span><span class="o">=</span><span class="n">IUPAC</span><span class="o">.</span><span class="n">upper</span><span class="p">(),</span>
            <span class="n">_iupac</span><span class="o">=</span><span class="n">IUPAC</span><span class="o">.</span><span class="n">lower</span><span class="p">(),</span>
            <span class="n">_out</span><span class="o">=</span><span class="n">to_file</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;running </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">cmd</span><span class="p">),</span> <span class="n">file</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">sp</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">shell</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">check</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></div>

<div class="viewcode-block" id="load_sequence_data.load_seq_region"><a class="viewcode-back" href="../../../../ensembl.brc4.runnable.html#ensembl.brc4.runnable.load_sequence_data.load_sequence_data.load_seq_region">[docs]</a>    <span class="k">def</span> <span class="nf">load_seq_region</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">cs</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">rank</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">asm_v</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">src_file</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">log_pfx</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">seq_level</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">additional_load</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;ensembl-analysis script (load_seq_region.pl) based utility for loading seq_regions FASTA sequences&quot;&quot;&quot;</span>
        <span class="n">en_root</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">param_required</span><span class="p">(</span><span class="s2">&quot;ensembl_root_dir&quot;</span><span class="p">)</span>
        <span class="n">cmd</span> <span class="o">=</span> <span class="p">(</span>
<span class="w">            </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;{_loader} {_db_string} {_asm_v_flag} -default_version -ignore_ambiguous_bases &quot;&quot;&quot;</span>
            <span class="o">+</span> <span class="sa">r</span><span class="s2">&quot;&quot;&quot;    -rank </span><span class="si">{_rank}</span><span class="s2"> -coord_system_name </span><span class="si">{_cs}</span><span class="s2"> </span><span class="si">{_sl_flag}</span><span class="s2"> -</span><span class="si">{_tag}</span><span class="s2">_file </span><span class="si">{_file}</span><span class="s2">&quot;&quot;&quot;</span>
            <span class="o">+</span> <span class="sa">r</span><span class="s2">&quot;&quot;&quot;     &gt; </span><span class="si">{_log}</span><span class="s2">.stdout 2&gt; </span><span class="si">{_log}</span><span class="s2">.stderr&quot;&quot;&quot;</span>
        <span class="p">)</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="n">_loader</span><span class="o">=</span><span class="s2">&quot;perl </span><span class="si">%s</span><span class="s2">&quot;</span>
            <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pjc</span><span class="p">(</span><span class="n">en_root</span><span class="p">,</span> <span class="sa">r</span><span class="s2">&quot;ensembl-analysis/scripts/assembly_loading/load_seq_region.pl&quot;</span><span class="p">)),</span>
            <span class="n">_db_string</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">db_string</span><span class="p">(),</span>
            <span class="n">_asm_v_flag</span><span class="o">=</span><span class="ow">not</span> <span class="n">additional_load</span> <span class="ow">and</span> <span class="sa">f</span><span class="s2">&quot;-coord_system_version </span><span class="si">{</span><span class="n">asm_v</span><span class="si">}</span><span class="s2">&quot;</span> <span class="ow">or</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
            <span class="n">_rank</span><span class="o">=</span><span class="n">rank</span><span class="p">,</span>
            <span class="n">_cs</span><span class="o">=</span><span class="n">cs</span><span class="p">,</span>
            <span class="n">_sl_flag</span><span class="o">=</span><span class="n">seq_level</span> <span class="ow">and</span> <span class="s2">&quot;-sequence_level&quot;</span> <span class="ow">or</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
            <span class="n">_tag</span><span class="o">=</span><span class="n">seq_level</span> <span class="ow">and</span> <span class="s2">&quot;fasta&quot;</span> <span class="ow">or</span> <span class="s2">&quot;agp&quot;</span><span class="p">,</span>
            <span class="n">_file</span><span class="o">=</span><span class="n">src_file</span><span class="p">,</span>
            <span class="n">_log</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">_seq&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">log_pfx</span><span class="p">),</span>
        <span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;running </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">cmd</span><span class="p">),</span> <span class="n">file</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">sp</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">shell</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">check</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></div>

<div class="viewcode-block" id="load_sequence_data.load_agp"><a class="viewcode-back" href="../../../../ensembl.brc4.runnable.html#ensembl.brc4.runnable.load_sequence_data.load_sequence_data.load_agp">[docs]</a>    <span class="k">def</span> <span class="nf">load_agp</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pair</span><span class="p">,</span> <span class="n">asm_v</span><span class="p">,</span> <span class="n">src_file</span><span class="p">,</span> <span class="n">log_pfx</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;ensembl script (load_agp.pl) based utility for loading seq_regions assembly data (AGPs)&quot;&quot;&quot;</span>
        <span class="n">en_root</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">param_required</span><span class="p">(</span><span class="s2">&quot;ensembl_root_dir&quot;</span><span class="p">)</span>
        <span class="p">(</span><span class="n">asm_n</span><span class="p">,</span> <span class="n">cmp_n</span><span class="p">)</span> <span class="o">=</span> <span class="n">pair</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;-&quot;</span><span class="p">)</span>
        <span class="n">cmd</span> <span class="o">=</span> <span class="p">(</span>
<span class="w">            </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;{_loader} {_db_string} -assembled_version {_asm_v} &quot;&quot;&quot;</span>
            <span class="o">+</span> <span class="sa">r</span><span class="s2">&quot;&quot;&quot;    -assembled_name </span><span class="si">{_asm}</span><span class="s2"> -component_name </span><span class="si">{_cmp}</span><span class="s2"> &quot;&quot;&quot;</span>
            <span class="o">+</span> <span class="sa">r</span><span class="s2">&quot;&quot;&quot;    -agp_file </span><span class="si">{_file}</span><span class="s2"> &quot;&quot;&quot;</span>
            <span class="o">+</span> <span class="sa">r</span><span class="s2">&quot;&quot;&quot;    &gt; </span><span class="si">{_log}</span><span class="s2">.stdout 2&gt; </span><span class="si">{_log}</span><span class="s2">.stderr&quot;&quot;&quot;</span>
        <span class="p">)</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="n">_loader</span><span class="o">=</span><span class="s2">&quot;perl </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pjc</span><span class="p">(</span><span class="n">en_root</span><span class="p">,</span> <span class="sa">r</span><span class="s2">&quot;ensembl-analysis/scripts/assembly_loading/load_agp.pl&quot;</span><span class="p">)),</span>
            <span class="n">_db_string</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">db_string</span><span class="p">(),</span>
            <span class="n">_asm_v</span><span class="o">=</span><span class="n">asm_v</span><span class="p">,</span>
            <span class="n">_asm</span><span class="o">=</span><span class="n">asm_n</span><span class="p">,</span>
            <span class="n">_cmp</span><span class="o">=</span><span class="n">cmp_n</span><span class="p">,</span>
            <span class="n">_file</span><span class="o">=</span><span class="n">src_file</span><span class="p">,</span>
            <span class="n">_log</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">_agp_</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">log_pfx</span><span class="p">,</span> <span class="n">pair</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;-&quot;</span><span class="p">,</span> <span class="s2">&quot;_&quot;</span><span class="p">)),</span>
        <span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;running </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">cmd</span><span class="p">),</span> <span class="n">file</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">sp</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">shell</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">check</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></div>

<div class="viewcode-block" id="load_sequence_data.set_toplevel"><a class="viewcode-back" href="../../../../ensembl.brc4.runnable.html#ensembl.brc4.runnable.load_sequence_data.load_sequence_data.set_toplevel">[docs]</a>    <span class="k">def</span> <span class="nf">set_toplevel</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">log_pfx</span><span class="p">,</span> <span class="n">ignored_cs</span><span class="o">=</span><span class="p">[]):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Set toplevel(6) seq_region_attrib using ensembl script.</span>

<span class="sd">        Uses set_toplevel.pl ensembl script.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># set top_level(6) seq_region_attrib</span>
        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">dirname</span><span class="p">(</span><span class="n">log_pfx</span><span class="p">),</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">en_root</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">param_required</span><span class="p">(</span><span class="s2">&quot;ensembl_root_dir&quot;</span><span class="p">)</span>
        <span class="n">cmd</span> <span class="o">=</span> <span class="p">(</span>
<span class="w">            </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;{_set_tl} {_db_string} {_ignored_cs} &quot;&quot;&quot;</span> <span class="o">+</span> <span class="sa">r</span><span class="s2">&quot;&quot;&quot;     &gt; </span><span class="si">{_log}</span><span class="s2">.stdout 2&gt; </span><span class="si">{_log}</span><span class="s2">.stderr&quot;&quot;&quot;</span>
        <span class="p">)</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="n">_set_tl</span><span class="o">=</span><span class="s2">&quot;perl </span><span class="si">%s</span><span class="s2">&quot;</span>
            <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pjc</span><span class="p">(</span><span class="n">en_root</span><span class="p">,</span> <span class="sa">r</span><span class="s2">&quot;ensembl-analysis/scripts/assembly_loading/set_toplevel.pl&quot;</span><span class="p">)),</span>
            <span class="n">_db_string</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">db_string</span><span class="p">(),</span>
            <span class="n">_ignored_cs</span><span class="o">=</span><span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="s2">&quot;-ignore_coord_system </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">x</span><span class="p">),</span> <span class="n">ignored_cs</span><span class="p">)),</span>
            <span class="n">_log</span><span class="o">=</span><span class="n">log_pfx</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;running </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">cmd</span><span class="p">),</span> <span class="n">file</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">)</span>
        <span class="n">sp</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">shell</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">check</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="c1"># remove toplevel attribute for seq_regions that are components</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">remove_components_from_toplevel</span><span class="p">(</span><span class="n">log_pfx</span><span class="p">)</span></div>

    <span class="c1">## SQL executor and utilities using plain SQL</span>
<div class="viewcode-block" id="load_sequence_data.run_sql_req"><a class="viewcode-back" href="../../../../ensembl.brc4.runnable.html#ensembl.brc4.runnable.load_sequence_data.load_sequence_data.run_sql_req">[docs]</a>    <span class="k">def</span> <span class="nf">run_sql_req</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sql</span><span class="p">,</span> <span class="n">log_pfx</span><span class="p">,</span> <span class="n">from_file</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">dirname</span><span class="p">(</span><span class="n">log_pfx</span><span class="p">),</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="n">sql_option</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;&quot;&quot; -sql &#39;</span><span class="si">{_sql}</span><span class="s2">&#39; &quot;&quot;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">_sql</span><span class="o">=</span><span class="n">sql</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">from_file</span><span class="p">:</span>
            <span class="n">sql_option</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;&quot;&quot; &lt; &#39;</span><span class="si">{_sql}</span><span class="s2">&#39; &quot;&quot;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">_sql</span><span class="o">=</span><span class="n">sql</span><span class="p">)</span>

        <span class="n">cmd</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;&quot;&quot;</span><span class="si">{_dbcmd}</span><span class="s2"> -url &quot;</span><span class="si">{_srv}{_dbname}</span><span class="s2">&quot; </span><span class="si">{_sql_option}</span><span class="s2"> &gt; </span><span class="si">{_out}</span><span class="s2"> 2&gt; </span><span class="si">{_err}</span><span class="s2">&quot;&quot;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="n">_dbcmd</span><span class="o">=</span><span class="s2">&quot;perl </span><span class="si">%s</span><span class="s2">/scripts/db_cmd.pl&quot;</span> <span class="o">%</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;EHIVE_ROOT_DIR&quot;</span><span class="p">),</span>
            <span class="n">_srv</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">param</span><span class="p">(</span><span class="s2">&quot;dbsrv_url&quot;</span><span class="p">),</span>
            <span class="n">_dbname</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">param</span><span class="p">(</span><span class="s2">&quot;db_name&quot;</span><span class="p">),</span>
            <span class="n">_sql_option</span><span class="o">=</span><span class="n">sql_option</span><span class="p">,</span>
            <span class="n">_out</span><span class="o">=</span><span class="n">log_pfx</span> <span class="o">+</span> <span class="s2">&quot;.stdout&quot;</span><span class="p">,</span>
            <span class="n">_err</span><span class="o">=</span><span class="n">log_pfx</span> <span class="o">+</span> <span class="s2">&quot;.stderr&quot;</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;running </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">cmd</span><span class="p">),</span> <span class="n">file</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">sp</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">shell</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">check</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></div>

<div class="viewcode-block" id="load_sequence_data.add_contig_ena_attrib"><a class="viewcode-back" href="../../../../ensembl.brc4.runnable.html#ensembl.brc4.runnable.load_sequence_data.load_sequence_data.add_contig_ena_attrib">[docs]</a>    <span class="k">def</span> <span class="nf">add_contig_ena_attrib</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">log_pfx</span><span class="p">,</span> <span class="n">cs_name</span><span class="o">=</span><span class="s2">&quot;contig&quot;</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Add ENA attrib for contigs if their names are ENA accessions</span>

<span class="sd">        Nno sequence_level checks are used -- just cs name.</span>
<span class="sd">        See ensembl-datacheck/lib/Bio/EnsEMBL/DataCheck/Checks/SeqRegionNamesINSDC.pm .</span>
<span class="sd">        SQL code.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">sql</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;&quot;&quot;insert ignore into seq_region_attrib (seq_region_id, attrib_type_id, value)</span>
<span class="s2">                select</span>
<span class="s2">                  sr.seq_region_id, at.attrib_type_id, &quot;ENA&quot;</span>
<span class="s2">                from</span>
<span class="s2">                  seq_region sr, coord_system cs, attrib_type at</span>
<span class="s2">                where   sr.coord_system_id = cs.coord_system_id</span>
<span class="s2">                    and cs.name = &quot;</span><span class="si">%s</span><span class="s2">&quot;</span>
<span class="s2">                    and at.code = &quot;external_db&quot;</span>
<span class="s2">              ;&quot;&quot;&quot;</span> <span class="o">%</span> <span class="p">(</span>
            <span class="n">cs_name</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">run_sql_req</span><span class="p">(</span><span class="n">sql</span><span class="p">,</span> <span class="n">log_pfx</span><span class="p">)</span></div>

<div class="viewcode-block" id="load_sequence_data.copy_sr_name_to_syn"><a class="viewcode-back" href="../../../../ensembl.brc4.runnable.html#ensembl.brc4.runnable.load_sequence_data.load_sequence_data.copy_sr_name_to_syn">[docs]</a>    <span class="k">def</span> <span class="nf">copy_sr_name_to_syn</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cs</span><span class="p">,</span> <span class="n">x_db</span><span class="p">,</span> <span class="n">log_pfx</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Store original seq_region names as seq_region_synonym</span>

<span class="sd">        Store original seq_region names (from a given cood_systen, &quot;cs&quot; param) as seq_region_synonyms (using &quot;x_db&quot; external source name)</span>
<span class="sd">        SQL code.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">asm_v</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">asm_name</span><span class="p">()</span>
        <span class="n">sql</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;&quot;&quot;insert into seq_region_synonym (seq_region_id, synonym, external_db_id)</span>
<span class="s2">                  select</span>
<span class="s2">                      sr.seq_region_id, sr.name, xdb.external_db_id</span>
<span class="s2">                  from</span>
<span class="s2">                     seq_region sr, external_db xdb, coord_system cs</span>
<span class="s2">                  where   xdb.db_name = &quot;</span><span class="si">%s</span><span class="s2">&quot;</span>
<span class="s2">                      and sr.coord_system_id = cs.coord_system_id</span>
<span class="s2">                      and cs.name = &quot;</span><span class="si">%s</span><span class="s2">&quot;</span>
<span class="s2">                      and cs.version = &quot;</span><span class="si">%s</span><span class="s2">&quot;</span>
<span class="s2">                      and sr.name like &quot;</span><span class="si">%%</span><span class="s2">._&quot;</span>
<span class="s2">                ;&quot;&quot;&quot;</span> <span class="o">%</span> <span class="p">(</span>
            <span class="n">x_db</span><span class="p">,</span>
            <span class="n">cs</span><span class="p">,</span>
            <span class="n">asm_v</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">run_sql_req</span><span class="p">(</span><span class="n">sql</span><span class="p">,</span> <span class="n">log_pfx</span><span class="p">)</span></div>

<div class="viewcode-block" id="load_sequence_data.add_asm_mappings"><a class="viewcode-back" href="../../../../ensembl.brc4.runnable.html#ensembl.brc4.runnable.load_sequence_data.load_sequence_data.add_asm_mappings">[docs]</a>    <span class="k">def</span> <span class="nf">add_asm_mappings</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cs_pairs</span><span class="p">,</span> <span class="n">log_pfx</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Adds &quot;assembly.mapping&quot; strings to meta table.</span>

<span class="sd">        Nullifies asm_mappings contig versions as well, but don&#39;t nullify toplevel</span>
<span class="sd">        Doesn&#39;t add mapping id there is a single CS</span>
<span class="sd">        SQL code.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">cs_pairs</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">cs_pairs</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="n">asm_v</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">asm_name</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">pair</span> <span class="ow">in</span> <span class="n">cs_pairs</span><span class="p">:</span>
            <span class="n">higher</span><span class="p">,</span> <span class="n">lower</span> <span class="o">=</span> <span class="n">pair</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;-&quot;</span><span class="p">)</span>
            <span class="n">sql</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;&quot;&quot;insert ignore into meta (species_id, meta_key, meta_value) values</span>
<span class="s2">                    (1, &quot;assembly.mapping&quot;, &quot;</span><span class="si">{_higher}</span><span class="s2">:</span><span class="si">{_v}</span><span class="s2">|</span><span class="si">{_lower}</span><span class="s2">:</span><span class="si">{_v}</span><span class="s2">&quot;)</span>
<span class="s2">                  ;&quot;&quot;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">_v</span><span class="o">=</span><span class="n">asm_v</span><span class="p">,</span> <span class="n">_higher</span><span class="o">=</span><span class="n">higher</span><span class="p">,</span> <span class="n">_lower</span><span class="o">=</span><span class="n">lower</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">run_sql_req</span><span class="p">(</span><span class="n">sql</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">pjc</span><span class="p">(</span><span class="n">log_pfx</span><span class="p">,</span> <span class="n">pair</span><span class="p">))</span></div>

<div class="viewcode-block" id="load_sequence_data.remove_components_from_toplevel"><a class="viewcode-back" href="../../../../ensembl.brc4.runnable.html#ensembl.brc4.runnable.load_sequence_data.load_sequence_data.remove_components_from_toplevel">[docs]</a>    <span class="k">def</span> <span class="nf">remove_components_from_toplevel</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">log_pfx</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Remove toplevel attribute for seq_regions that are &quot;components&quot; (parts of different seq_regions).</span>

<span class="sd">        SQL code.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># get list of seq_regions that are components</span>
        <span class="n">sql_not_toplevel_list</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">          select distinct a.cmp_seq_region_id, sr_c.name, cs_c.name</span>
<span class="s2">            from assembly a,</span>
<span class="s2">                 seq_region sr_c, seq_region sr_a,</span>
<span class="s2">                 coord_system cs_c, coord_system cs_a</span>
<span class="s2">            where a.cmp_seq_region_id = sr_c.seq_region_id</span>
<span class="s2">              and a.asm_seq_region_id = sr_a.seq_region_id</span>
<span class="s2">              and sr_c.coord_system_id = cs_c.coord_system_id</span>
<span class="s2">              and sr_a.coord_system_id = cs_a.coord_system_id</span>
<span class="s2">              and cs_c.attrib like &quot;</span><span class="si">%d</span><span class="s2">efault_version%&quot;</span>
<span class="s2">              and cs_a.attrib like &quot;</span><span class="si">%d</span><span class="s2">efault_version%&quot;</span>
<span class="s2">              and sr_c.seq_region_id in (</span>
<span class="s2">                select distinct seq_region_id</span>
<span class="s2">                  from seq_region_attrib</span>
<span class="s2">                  where attrib_type_id = 6 and value = 1</span>
<span class="s2">              )</span>
<span class="s2">        &quot;&quot;&quot;</span>
        <span class="c1"># perhaps, make sense to check sr_c.coord_system_id != sr_a.coord_system_id</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">run_sql_req</span><span class="p">(</span><span class="n">sql_not_toplevel_list</span><span class="p">,</span> <span class="s2">&quot;.&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">log_pfx</span><span class="p">,</span> <span class="s2">&quot;not_toplevel_list&quot;</span><span class="p">]))</span>

        <span class="c1"># delete wrongly assigned attribs</span>
        <span class="n">sql_not_toplevel_delete</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">          delete from seq_region_attrib</span>
<span class="s2">            where attrib_type_id = 6 and value = 1</span>
<span class="s2">              and seq_region_id in (</span>
<span class="s2">                select distinct a.cmp_seq_region_id</span>
<span class="s2">                  from assembly a,</span>
<span class="s2">                       seq_region sr_c, seq_region sr_a,</span>
<span class="s2">                       coord_system cs_c, coord_system cs_a</span>
<span class="s2">                  where a.cmp_seq_region_id = sr_c.seq_region_id</span>
<span class="s2">                    and a.asm_seq_region_id = sr_a.seq_region_id</span>
<span class="s2">                    and sr_c.coord_system_id = cs_c.coord_system_id</span>
<span class="s2">                    and sr_a.coord_system_id = cs_a.coord_system_id</span>
<span class="s2">                    and cs_c.attrib like &quot;</span><span class="si">%d</span><span class="s2">efault_version%&quot;</span>
<span class="s2">                    and cs_a.attrib like &quot;</span><span class="si">%d</span><span class="s2">efault_version%&quot;</span>
<span class="s2">              );</span>
<span class="s2">        &quot;&quot;&quot;</span>
        <span class="c1"># perhaps, check sr_c.coord_system_id != sr_a.coord_system_id</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">run_sql_req</span><span class="p">(</span><span class="n">sql_not_toplevel_delete</span><span class="p">,</span> <span class="s2">&quot;.&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">log_pfx</span><span class="p">,</span> <span class="s2">&quot;not_toplevel_delete&quot;</span><span class="p">]))</span></div>

<div class="viewcode-block" id="load_sequence_data.sr_name_unversion"><a class="viewcode-back" href="../../../../ensembl.brc4.runnable.html#ensembl.brc4.runnable.load_sequence_data.load_sequence_data.sr_name_unversion">[docs]</a>    <span class="k">def</span> <span class="nf">sr_name_unversion</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cs</span><span class="p">,</span> <span class="n">tbl</span><span class="p">,</span> <span class="n">fld</span><span class="p">,</span> <span class="n">log_pfx</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Remove version suffix from the seq_region names</span>

<span class="sd">        Removes &#39;\.\d+$&#39; suffices from the seq_region names</span>
<span class="sd">        SQL code.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># select synonym, substr(synonym,  1, locate(&quot;.&quot;, synonym, length(synonym)-2)-1)</span>
        <span class="c1">#     from seq_region_synonym  where synonym like &quot;%._&quot;</span>
        <span class="n">asm_v</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">asm_name</span><span class="p">()</span>
        <span class="n">sql</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;&quot;&quot;update </span><span class="si">{_tbl}</span><span class="s2"> t, seq_region sr, coord_system cs</span>
<span class="s2">                    set</span>
<span class="s2">                      t.</span><span class="si">{_fld}</span><span class="s2"> = substr(t.</span><span class="si">{_fld}</span><span class="s2">,  1, locate(&quot;.&quot;, t.</span><span class="si">{_fld}</span><span class="s2">, length(t.</span><span class="si">{_fld}</span><span class="s2">)-2)-1)</span>
<span class="s2">                    where t.</span><span class="si">{_fld}</span><span class="s2"> like &quot;%._&quot;</span>
<span class="s2">                      and t.seq_region_id = sr.seq_region_id</span>
<span class="s2">                      and sr.coord_system_id = cs.coord_system_id</span>
<span class="s2">                      and cs.name = &quot;</span><span class="si">{_cs}</span><span class="s2">&quot;</span>
<span class="s2">                      and cs.version = &quot;</span><span class="si">{_asm_v}</span><span class="s2">&quot;</span>
<span class="s2">                ;&quot;&quot;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="n">_tbl</span><span class="o">=</span><span class="n">tbl</span><span class="p">,</span> <span class="n">_fld</span><span class="o">=</span><span class="n">fld</span><span class="p">,</span> <span class="n">_cs</span><span class="o">=</span><span class="n">cs</span><span class="p">,</span> <span class="n">_asm_v</span><span class="o">=</span><span class="n">asm_v</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">run_sql_req</span><span class="p">(</span><span class="n">sql</span><span class="p">,</span> <span class="n">log_pfx</span><span class="p">)</span></div>

<div class="viewcode-block" id="load_sequence_data.nullify_ctg_cs_version"><a class="viewcode-back" href="../../../../ensembl.brc4.runnable.html#ensembl.brc4.runnable.load_sequence_data.load_sequence_data.nullify_ctg_cs_version">[docs]</a>    <span class="k">def</span> <span class="nf">nullify_ctg_cs_version</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cs_order</span><span class="p">,</span> <span class="n">log_pfx</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Nullify every CS version with rank larger than that of &quot;contig&quot;, but don&#39;t nullify toplevel ones.</span>

<span class="sd">        SQL code</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">asm_v</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">asm_name</span><span class="p">()</span>
        <span class="c1"># get cs_info (and if they have toplevel regions)</span>
        <span class="n">sql</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;&quot;&quot;select cs.coord_system_id as coord_system_id,</span>
<span class="s2">                         cs.name, cs.rank, (tl.coord_system_id is NULL) as no_toplevel</span>
<span class="s2">                    from coord_system cs</span>
<span class="s2">                      left join (</span>
<span class="s2">                        select distinct sr.coord_system_id</span>
<span class="s2">                          from seq_region sr, seq_region_attrib sra, attrib_type at</span>
<span class="s2">                          where at.code = &quot;toplevel&quot;</span>
<span class="s2">                            and sra.attrib_type_id = at.attrib_type_id</span>
<span class="s2">                            and sra.value = 1</span>
<span class="s2">                            and sra.seq_region_id = sr.seq_region_id</span>
<span class="s2">                      ) as tl on tl.coord_system_id = cs.coord_system_id</span>
<span class="s2">                    where cs.version = &quot;</span><span class="si">{_asm_v}</span><span class="s2">&quot;</span>
<span class="s2">                    order by rank</span>
<span class="s2">              ;&quot;&quot;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="n">_asm_v</span><span class="o">=</span><span class="n">asm_v</span>
        <span class="p">)</span>
        <span class="c1"># run_sql</span>
        <span class="n">toplvl_pfx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pjc</span><span class="p">(</span><span class="n">log_pfx</span><span class="p">,</span> <span class="s2">&quot;toplvl_info&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">run_sql_req</span><span class="p">(</span><span class="n">sql</span><span class="p">,</span> <span class="n">toplvl_pfx</span><span class="p">)</span>
        <span class="c1"># load info</span>
        <span class="n">cs_info</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">toplvl_pfx</span> <span class="o">+</span> <span class="s2">&quot;.stdout&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">header</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">f</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">header</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">header</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="k">continue</span>
                <span class="n">cs_info</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">header</span><span class="p">,</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">())))</span>
        <span class="c1"># return if there&#39;s no coord_systems to nullify versions for</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">cs_info</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="c1"># get list of known cs from cs_order to clean version from</span>
        <span class="n">nullify_cs_version_from</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">param</span><span class="p">(</span><span class="s2">&quot;nullify_cs_version_from&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">nullify_cs_version_from</span> <span class="ow">or</span> <span class="n">nullify_cs_version_from</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">cs_order</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="n">cs_thr_index</span> <span class="o">=</span> <span class="n">cs_order</span><span class="p">[</span><span class="n">nullify_cs_version_from</span><span class="p">]</span>
        <span class="n">cs_names_to_keep_ver</span> <span class="o">=</span> <span class="nb">frozenset</span><span class="p">([</span><span class="n">nm</span> <span class="k">for</span> <span class="p">(</span><span class="n">nm</span><span class="p">,</span> <span class="n">ind</span><span class="p">)</span> <span class="ow">in</span> <span class="n">cs_order</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">ind</span> <span class="o">&gt;</span> <span class="n">cs_thr_index</span><span class="p">])</span>

        <span class="c1"># choose cs rank threshold to start clearing version from</span>
        <span class="n">clear_lst</span> <span class="o">=</span> <span class="p">[</span>
            <span class="p">(</span><span class="n">cs</span><span class="p">[</span><span class="s2">&quot;coord_system_id&quot;</span><span class="p">],</span> <span class="n">cs</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">])</span>
            <span class="k">for</span> <span class="n">cs</span> <span class="ow">in</span> <span class="n">cs_info</span>
            <span class="k">if</span> <span class="p">(</span><span class="nb">bool</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">cs</span><span class="p">[</span><span class="s2">&quot;no_toplevel&quot;</span><span class="p">]))</span> <span class="ow">and</span> <span class="n">cs</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">cs_names_to_keep_ver</span><span class="p">)</span>
        <span class="p">]</span>

        <span class="c1"># run sql</span>
        <span class="k">if</span> <span class="n">clear_lst</span><span class="p">:</span>
            <span class="n">clear_pfx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pjc</span><span class="p">(</span><span class="n">log_pfx</span><span class="p">,</span> <span class="s2">&quot;clear&quot;</span><span class="p">)</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">clear_pfx</span> <span class="o">+</span> <span class="s2">&quot;.sql&quot;</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">clear_sql</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">cs_id</span><span class="p">,</span> <span class="n">cs_name</span> <span class="ow">in</span> <span class="n">clear_lst</span><span class="p">:</span>
                    <span class="n">sql</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">                        update meta set</span>
<span class="s2">                            meta_value=replace(meta_value, &quot;|</span><span class="si">{_cs_name}</span><span class="s2">:</span><span class="si">{_asm_v}</span><span class="s2">&quot;, &quot;|</span><span class="si">{_cs_name}</span><span class="s2">&quot;)</span>
<span class="s2">                            where meta_key=&quot;assembly.mapping&quot;;</span>
<span class="s2">                        update coord_system set version = NULL where coord_system_id = </span><span class="si">{_cs_id}</span><span class="s2">;</span>
<span class="s2">                    &quot;&quot;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                        <span class="n">_asm_v</span><span class="o">=</span><span class="n">asm_v</span><span class="p">,</span> <span class="n">_cs_name</span><span class="o">=</span><span class="n">cs_name</span><span class="p">,</span> <span class="n">_cs_id</span><span class="o">=</span><span class="n">cs_id</span>
                    <span class="p">)</span>
                    <span class="nb">print</span><span class="p">(</span><span class="n">sql</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="n">clear_sql</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">run_sql_req</span><span class="p">(</span><span class="n">clear_pfx</span> <span class="o">+</span> <span class="s2">&quot;.sql&quot;</span><span class="p">,</span> <span class="n">clear_pfx</span><span class="p">,</span> <span class="n">from_file</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></div>

<div class="viewcode-block" id="load_sequence_data.load_map_from_core_db"><a class="viewcode-back" href="../../../../ensembl.brc4.runnable.html#ensembl.brc4.runnable.load_sequence_data.load_sequence_data.load_map_from_core_db">[docs]</a>    <span class="k">def</span> <span class="nf">load_map_from_core_db</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">table</span><span class="p">,</span> <span class="n">cols</span><span class="p">,</span> <span class="n">work_dir</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Load 2 &quot;cols&quot; from core db &quot;table&quot; as map</span>

<span class="sd">        Load { cols[0] : cols[1] } map from the core db &quot;table&quot;</span>
<span class="sd">        SQL code</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">out_pfx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pjc</span><span class="p">(</span><span class="n">work_dir</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">table</span><span class="si">}</span><span class="s2">_map&quot;</span><span class="p">)</span>
        <span class="n">sql</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;&quot;&quot;select </span><span class="si">{</span><span class="n">cols</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">cols</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s2"> FROM </span><span class="si">{</span><span class="n">table</span><span class="si">}</span><span class="s2">;&quot;&quot;&quot;</span>
        <span class="n">res</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">run_sql_req</span><span class="p">(</span><span class="n">sql</span><span class="p">,</span> <span class="n">out_pfx</span><span class="p">)</span>

        <span class="n">out_file</span> <span class="o">=</span> <span class="n">out_pfx</span> <span class="o">+</span> <span class="s2">&quot;.stdout&quot;</span>
        <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">load_map_from_sql_stdout</span><span class="p">(</span><span class="n">out_file</span><span class="p">,</span> <span class="n">skip_header</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">data</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;No &#39;</span><span class="si">{</span><span class="n">table</span><span class="si">}</span><span class="s2">&#39; map loaded from &#39;</span><span class="si">{</span><span class="n">out_file</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">data</span></div>

<div class="viewcode-block" id="load_sequence_data.load_seq_region_synonyms_trios_from_core_db"><a class="viewcode-back" href="../../../../ensembl.brc4.runnable.html#ensembl.brc4.runnable.load_sequence_data.load_sequence_data.load_seq_region_synonyms_trios_from_core_db">[docs]</a>    <span class="k">def</span> <span class="nf">load_seq_region_synonyms_trios_from_core_db</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">work_dir</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">:</span>
        <span class="c1"># was get_db_syns</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Load seq_region_synonyms from from core db into [(seq_region_id, name, synonym)...] list</span>

<span class="sd">        SQL code</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">out_pfx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pjc</span><span class="p">(</span><span class="n">work_dir</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;seq_region_synonyms&quot;</span><span class="p">)</span>
        <span class="n">sql</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;&quot;&quot;select sr.seq_region_id as seq_region_id, sr.name, srs.synonym</span>
<span class="s2">                 from seq_region sr left join seq_region_synonym srs</span>
<span class="s2">                 on sr.seq_region_id = srs.seq_region_id</span>
<span class="s2">                 order by sr.seq_region_id</span>
<span class="s2">              ;&quot;&quot;&quot;</span>

        <span class="n">res</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">run_sql_req</span><span class="p">(</span><span class="n">sql</span><span class="p">,</span> <span class="n">out_pfx</span><span class="p">)</span>

        <span class="n">syn_trios</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">out_file</span> <span class="o">=</span> <span class="n">out_pfx</span> <span class="o">+</span> <span class="s2">&quot;.stdout&quot;</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">out_file</span><span class="p">)</span> <span class="k">as</span> <span class="n">syns_file</span><span class="p">:</span>
            <span class="n">skip_header</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">syns_file</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">skip_header</span><span class="p">:</span>
                    <span class="n">skip_header</span> <span class="o">=</span> <span class="kc">False</span>
                    <span class="k">continue</span>
                <span class="p">(</span><span class="n">sr_id</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">syn</span><span class="p">)</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">syn_trios</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">sr_id</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">syn</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">syn_trios</span></div>

<div class="viewcode-block" id="load_sequence_data.insert_to_db"><a class="viewcode-back" href="../../../../ensembl.brc4.runnable.html#ensembl.brc4.runnable.load_sequence_data.load_sequence_data.insert_to_db">[docs]</a>    <span class="k">def</span> <span class="nf">insert_to_db</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">list_of_tuples</span><span class="p">:</span> <span class="nb">list</span><span class="p">,</span> <span class="n">table_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">col_names</span><span class="p">:</span> <span class="nb">list</span><span class="p">,</span> <span class="n">work_dir</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">ignore</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Insert into the core db&#39;s {table_name} tuples from {list_of_tuples} as col_names.</span>

<span class="sd">        Use `quote_or_null` (see definition below) method for string values, when putting values into `list_of_tuples`</span>
<span class="sd">        SQL code</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># return if nothing to do</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">list_of_tuples</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="c1"># prepare request parts</span>
        <span class="n">ignore_str</span> <span class="o">=</span> <span class="n">ignore</span> <span class="ow">and</span> <span class="s2">&quot;IGNORE&quot;</span> <span class="ow">or</span> <span class="s2">&quot;&quot;</span>
        <span class="n">cols_str</span> <span class="o">=</span> <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">col_names</span><span class="p">)</span>

        <span class="c1"># generate file with the insert SQL command</span>
        <span class="n">insert_sql_file</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pjc</span><span class="p">(</span><span class="n">work_dir</span><span class="p">,</span> <span class="s2">&quot;insert.sql&quot;</span><span class="p">)</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">insert_sql_file</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">sql</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;INSERT </span><span class="si">{</span><span class="n">ignore_str</span><span class="si">}</span><span class="s2"> INTO </span><span class="si">{</span><span class="n">table_name</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="n">cols_str</span><span class="si">}</span><span class="s2">) VALUES&quot;</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="n">sql</span><span class="p">)</span>
            <span class="n">values_sep</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
            <span class="k">for</span> <span class="n">tpl</span> <span class="ow">in</span> <span class="n">list_of_tuples</span><span class="p">:</span>
                <span class="n">tpl_str</span> <span class="o">=</span> <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">tpl</span><span class="p">))</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">values_sep</span><span class="si">}</span><span class="s2">(</span><span class="si">{</span><span class="n">tpl_str</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="n">sql</span><span class="p">)</span>
                <span class="n">values_sep</span> <span class="o">=</span> <span class="s2">&quot;, &quot;</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;;&quot;</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="n">sql</span><span class="p">)</span>

        <span class="c1"># run insert SQL from file</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">run_sql_req</span><span class="p">(</span><span class="n">insert_sql_file</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">pjc</span><span class="p">(</span><span class="n">work_dir</span><span class="p">,</span> <span class="s2">&quot;insert&quot;</span><span class="p">),</span> <span class="n">from_file</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></div>

<div class="viewcode-block" id="load_sequence_data.quote_or_null"><a class="viewcode-back" href="../../../../ensembl.brc4.runnable.html#ensembl.brc4.runnable.load_sequence_data.load_sequence_data.quote_or_null">[docs]</a>    <span class="k">def</span> <span class="nf">quote_or_null</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">val</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">quotes</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;&#39;&quot;</span><span class="p">,</span> <span class="n">null</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;NULL&quot;</span><span class="p">,</span> <span class="n">strings_only</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return `val` wrapped in `quotes` or `null` value</span>

<span class="sd">        Quotes only strings (instances of `str`) if strings_only is True.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">val</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">null</span>
        <span class="k">if</span> <span class="n">strings_only</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">quotes</span><span class="si">}{</span><span class="n">val</span><span class="si">}{</span><span class="n">quotes</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="k">return</span> <span class="n">val</span></div>

<div class="viewcode-block" id="load_sequence_data.update_db_single_group"><a class="viewcode-back" href="../../../../ensembl.brc4.runnable.html#ensembl.brc4.runnable.load_sequence_data.load_sequence_data.update_db_single_group">[docs]</a>    <span class="k">def</span> <span class="nf">update_db_single_group</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">dict_of_col_to_value</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">table_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">work_dir</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">where</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Update given `table` name in db; set `col = val` for all key/value pairs from `dict_of_cols_to_values`</span>

<span class="sd">        If `where` condition is present its value is used for the &quot;WHERE&quot; SQL clause.</span>
<span class="sd">        Use `quote_or_null` (see definition below) method for string values, when putting values into `list_of_tuples`</span>

<span class="sd">        SQL code</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># return if nothing to do</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">dict_of_col_to_value</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="c1"># prepare request parts</span>
        <span class="n">where_str</span> <span class="o">=</span> <span class="n">where</span> <span class="ow">and</span> <span class="sa">f</span><span class="s2">&quot;WHERE </span><span class="si">{</span><span class="n">where</span><span class="si">}</span><span class="s2">&quot;</span> <span class="ow">or</span> <span class="s2">&quot;&quot;</span>
        <span class="n">col_val_str</span> <span class="o">=</span> <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">col</span><span class="si">}</span><span class="s2"> = </span><span class="si">{</span><span class="n">val</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">col</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">dict_of_col_to_value</span><span class="o">.</span><span class="n">items</span><span class="p">()])</span>

        <span class="c1"># generate file with the insert SQL command</span>
        <span class="n">update_sql_file</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pjc</span><span class="p">(</span><span class="n">work_dir</span><span class="p">,</span> <span class="s2">&quot;update.sql&quot;</span><span class="p">)</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">insert_sql_file</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">sql</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;UPDATE </span><span class="si">{</span><span class="n">table_name</span><span class="si">}</span><span class="s2"> SET </span><span class="si">{</span><span class="n">col_val_str</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">where_str</span><span class="si">}</span><span class="s2">;&quot;</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="n">sql</span><span class="p">)</span>
            <span class="n">values_sep</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
            <span class="k">for</span> <span class="n">tpl</span> <span class="ow">in</span> <span class="n">list_of_tuples</span><span class="p">:</span>
                <span class="n">tpl_str</span> <span class="o">=</span> <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">tpl</span><span class="p">))</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">values_sep</span><span class="si">}</span><span class="s2">(</span><span class="si">{</span><span class="n">tpl_str</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="n">sql</span><span class="p">)</span>
                <span class="n">values_sep</span> <span class="o">=</span> <span class="s2">&quot;, &quot;</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;;&quot;</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="n">sql</span><span class="p">)</span>

        <span class="c1"># run insert SQL from file</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">run_sql_req</span><span class="p">(</span><span class="n">update_sql_file</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">pjc</span><span class="p">(</span><span class="n">work_dir</span><span class="p">,</span> <span class="s2">&quot;update&quot;</span><span class="p">),</span> <span class="n">from_file</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></div>

<div class="viewcode-block" id="load_sequence_data.get_toplevel_from_cs"><a class="viewcode-back" href="../../../../ensembl.brc4.runnable.html#ensembl.brc4.runnable.load_sequence_data.load_sequence_data.get_toplevel_from_cs">[docs]</a>    <span class="k">def</span> <span class="nf">get_toplevel_from_cs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">coord_system_name</span><span class="p">,</span> <span class="n">work_dir</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns list of [ (seq_region_name, seq_region_id, &quot;&quot;) ] trios for toplevel seq_regions from coord system with `coord_system_name`</span>
<span class="sd">          or having  &quot;coord_system_tag&quot; attribute with the `coord_system_name` value</span>

<span class="sd">        SQL code</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">out_pfx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pjc</span><span class="p">(</span><span class="n">work_dir</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;toplevel_from_</span><span class="si">{</span><span class="n">coord_system_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">sql</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;&quot;&quot;SELECT DISTINCT sr.name, sr.seq_region_id</span>
<span class="s2">                FROM seq_region sr,</span>
<span class="s2">                     seq_region_attrib sra,</span>
<span class="s2">                     coord_system cs,</span>
<span class="s2">                     attrib_type at</span>
<span class="s2">                WHERE sr.seq_region_id = sra.seq_region_id</span>
<span class="s2">                  AND sr.coord_system_id = cs.coord_system_id</span>
<span class="s2">                  AND sra.attrib_type_id = at.attrib_type_id</span>
<span class="s2">                  AND (  ( cs.name = &quot;</span><span class="si">{</span><span class="n">coord_system_name</span><span class="si">}</span><span class="s2">&quot; and at.code = &quot;toplevel&quot; )</span>
<span class="s2">                      OR ( at.code = &quot;coord_system_tag&quot; and sra.value = &quot;</span><span class="si">{</span><span class="n">coord_system_name</span><span class="si">}</span><span class="s2">&quot; )</span>
<span class="s2">                      )</span>
<span class="s2">                  ORDER BY sr.seq_region_id;</span>
<span class="s2">               &quot;&quot;&quot;</span>

        <span class="n">res</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">run_sql_req</span><span class="p">(</span><span class="n">sql</span><span class="p">,</span> <span class="n">out_pfx</span><span class="p">)</span>

        <span class="n">sr_trios</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">out_file</span> <span class="o">=</span> <span class="n">out_pfx</span> <span class="o">+</span> <span class="s2">&quot;.stdout&quot;</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">out_file</span><span class="p">)</span> <span class="k">as</span> <span class="n">sr_file</span><span class="p">:</span>
            <span class="n">skip_header</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">sr_file</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">skip_header</span><span class="p">:</span>
                    <span class="n">skip_header</span> <span class="o">=</span> <span class="kc">False</span>
                    <span class="k">continue</span>
                <span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">sr_id</span><span class="p">)</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">sr_trios</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">name</span><span class="p">,</span> <span class="n">sr_id</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">))</span>

        <span class="k">return</span> <span class="n">sr_trios</span></div></div>
</pre></div>

            <div class="clearer"></div>
          </div>
        </div>
      </div>
        </div>
        <div class="sidebar">
          
          <h3>Table of Contents</h3>
          <p class="caption" role="heading"><span class="caption-text">Index</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../usage.html">Usage</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../install.html">API Setup and installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../modules.html">ensembl</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../license.html">License</a></li>
</ul>

          <div role="search">
            <h3 style="margin-top: 1.5em;">Search</h3>
            <form class="search" action="../../../../search.html" method="get">
                <input type="text" name="q" />
                <input type="submit" value="Go" />
            </form>
          </div>

        </div>
        <div class="clearer"></div>
      </div>
    </div>

    <div class="footer-wrapper">
      <div class="footer">
        <div class="left">
          <div role="navigation" aria-label="related navigaton">
            <a href="../../../../py-modindex.html" title="Python Module Index"
              >modules</a> |
            <a href="../../../../genindex.html" title="General Index"
              >index</a>
          </div>
          <div role="note" aria-label="source link">
          </div>
        </div>

        <div class="right">
          
    <div class="footer" role="contentinfo">
    &#169; Copyright [2016-2023] EMBL-European Bioinformatics Institute.
      Created using <a href="https://www.sphinx-doc.org/">Sphinx</a> 7.1.2.
    </div>
        </div>
        <div class="clearer"></div>
      </div>
    </div>

  </body>
</html>